/*CloudWall 2.4.1 Core; (c) 2018 ermouth*/
!function(a){function b(){for(var a=[],b=0,d=arguments.length;b<d;b++)a.push(arguments[b]);var e={};if(i(a[0])?e=k(a[0]):h(a[0])&&(e=i(a[1])?k(a[1]):e,e.name=a[0]),!e.name)throw new Error("Missing/invalid DB name");var g=e.name,o=c(e);if(l[o])return l[o];/^http[s]?:\/\//.test(g)||"/"==g[0]||(m[g]?e.name=m[g]:e.name=o),/^http[s]?:\/\//.test(e.name)||"/"==e.name[0]||(e.adapter="idb");var b,p=new n(e),q=f(),r={_key:o,_local:!/^(\/|http[s]?:\/\/)/.test(e.name),then:q.then,catch:q.catch,fail:q.fail,always:q.always},s=[];for(b in p)s.push(b);return s.forEach(function(a){"_"!=a.to(1)&&(j(p[a])?r[a]=p[a].bind(p):i(p[a])?"replicate"!=a&&(r[a]=p[a]):r[a]=p[a])}),l[o]=r,r.replicate={to:p.replicate.to.bind(p),from:p.replicate.from.bind(p)},q.resolve(r),l[o]}function c(a){var b=i(e.userCtx)?e.userCtx:null,c=i(e.CW)?e.CW.storageSalt||"":"",d=i(e.CW)?!!e.CW.static:!!j(e.config)&&!!e.config("static"),f=(c?"_"+c+"_":"")+a.name;return!b||d?a.name+"":/^http[s]?:\/\//.test(a.name)?"cw-"+g([b.name,Object.merge({size:100},Object.reject(a,["adapter"]))]):m[a.name]?"cw-"+g([b.name,{name:f,url:m[a.name]}]):"cw-"+g([b.name,{name:f}])}function d(a){i(a)&&$.extend(m,a)}const e=a.cw,f=$.Deferred,g=e.lib.crc2,h=Object.isString,i=Object.isObject,j=Object.isFunction,k=(Object.keys,Object.clone);var l={},m={},n=a.PouchDB.bind(a.PouchDB),o=b;o._remap=d,e.pouch=n,a.PouchDB=o}(window),function(a){function b(a){var b=Date.now();return(Date.now()+"").substr(0,12)+d(a+" "+b+" "+Number.random(-1e12,1e12))}function c(a){return/^[1-2]\d{11}[a-z0-9]{8}$/.test(a)||/^cw\-([A-Z][A-Za-z_0-9]+\-)+[a-z0-9]{4}$/.test(a)}const d=cw.lib.hash8;a.cw.uuid=b.fill(void 0),a.cw.uuid.test=c.fill(void 0)}(window),"cw"in window||(window.cw={}),function(a){function b(b){var e=l(a.config)?a.config("profile"):null;if(i=/^(object|string)$/.test($.type(e))?Object.clone(e,!0):"cw/cw",Object.isString(i)){if(a.profile=d,"/"==i[0]);else if(/^http[s]?:\/\/.+/.test(i));else{var f=i.split("/").compact(!0);2!=f.length&&(f=["cw","cw"]),g=f[0],h=f[1]}return d(b)}return c(b)}function c(b){var c=$.Deferred();if(b)c.reject({error:!0,status:403,name:"forbidden",reason:"forbidden",message:"Profile is fixed"});else{var d=a.me()||(a.userCtx||{}).name;c.resolve($.extend(!0,{},i,{name:d,uid:a.lib.hash8(d)}))}return c.promise()}function d(b){function c(a){a.type="settings",a.stamp=Date.now(),f.put(a).then(function(a){d.resolve({ok:!0})}).catch(function(a){d.reject(a)})}var d=$.Deferred();return f||(f=new PouchDB(g)),b&&j(b)?l(a.config)&&!a.config("profileWritable")?d.reject({error:!0,status:403,name:"forbidden",reason:"forbidden",message:"Profile is not writable"}):f.get(h).then(function(a){var f=e(a,b);return f?d.reject(f):(b._rev=a._rev,c(b),void 0)}).catch(function(){var a=e(null,b);return a?d.reject(a):(c(b),void 0)}):f.get(h).then(function(a){d.resolve(a)}).catch(function(a){d.reject(a)}),d.promise()}function e(a,b){var c={error:!0,name:"forbidden",reason:"forbidden",status:403},d=[];return a&&(a.crypto&&!b.crypto&&d.push("Can’t save already encrypted profile as decrypted"),a.name!=b.name&&d.push("Stored and updated profiles must have equal names")),d||(/^[a-z][a-z0-9_\-]{1,40}$/i.test(b.name)||d.push("Allowed chars for name are latins, nums and _-"),b.pic&&/^data:image\/(jpeg|png);base64,/.test(b.pic)||d.push("No pic found or pic is of invalid type"),!b.CRYPTO^!b.crypto&&d.push("Incomplete crypto data"),b.crypto||(k(b.keys)&&k(b.dbs)?b.dbs.length||d.push("DB list can’t be empty"):d.push("Doc must have .keys and .dbs lists"))),!!d.length&&(c.message=d.join("\n"),c)}var f,g,h,i,j=(PouchDB,Object.isObject),k=Object.isArray,l=Object.isFunction;a.profile=b}(window.cw),"cw"in window||(window.cw={}),cw.log||function(){var a=function(){function b(a){var b=0,c=[],d="";for(b;b<a.length;b++)d=JSON.stringify(a[b]),"string"==typeof d&&(p>=d.length?c.push(d):c.push(JSON.stringify("Truncated "+$.type(a[b])+": "+(g(a[b])?a[b]:d).truncate(p-1,"middle","…"))));return"["+c.join(",")+"]"}function c(a){var b="",c=k.getItem(l)||"";c.length+a.length>n?(b=k.getItem(m)||"",b.length>0&&(b+="\n"),b+=c,b.length>o?(b=b.last(o-1),b=b.from(1+b.indexOf("\n")),k.setItem(m,b)):k.setItem(m,b),k.setItem(l,a),b="",c=""):(k.setItem(l,(c.length?c+"\n":"")+a),c="")}function d(b){var c,d,e;for(d=0;d<b.length;d++)if(c=b[d],null!==c&&void 0!==c&&!i(c)&&!g(c)&&!Object.isDate(c))if(h(c)||f(c))try{c=JSON.stringify(c)}catch(a){c="Parsing "+$.type(c)+" of keys:["+Object.keys(c).join(", ")+"] failed: "+a.message,b[d]=c}else j(c)?b[d]="function "+c.name+"(){"+a.length+"}":"object"==typeof c&&g(c.jquery)&&j(c.each)?c.length||j(c.size)&&c.size()?(e=[],c.each(function(){var a=this,b=a.id,c=Array.prototype.slice.call(a.classList,0);e.push(a.nodeName+(b?"#"+b:"")+(c.length?"."+c.join("."):""))}),b[d]={jQuery:e}):b[d]={jQuery:[]}:b[d]=null}function e(){return q}var f=Object.isArray,g=(Object.isBoolean,Object.isString),h=Object.isObject,i=Object.isNumber,j=(Object.isRegExp,Object.isFunction),k=localStorage,l="_cw_log_curr",m="_cw_log_prev",n=5e4,o=1e6,p=500,q=j(cw.session)?cw.session():Number.random(46656,1679615).toString(36),r=Date.now()-2e4,s=Date.now();j(cw.session)||(cw.session=e),cw.log=function(a){var e,f=[],g=arguments.length,h=Date.now();if(null!=a||1!=g)return!g||1===g&&i(a)?i(a)?(e=a.clamp(1,1e6),f=(k.getItem(l)||"").split("\n"),f.length<e&&(f=(k.getItem(m)||"").split("\n").concat(f)),f=f.compact(!0).last(e),f):(k.getItem(l)||"").split("\n").compact(!0):(f=Array.prototype.slice.call(arguments,0),d(f),f.unshift(q),h-r<2e3?(f.unshift("+"+(h-s)),s=h):(f.unshift(h),r=s=h),c(b(f)),f=[],void 0)}.fill()};try{a()}catch(a){}Object.isFunction(cw.log)||(cw.log=console.log.bind(console))}(),cw.crypto||(cw.crypto=function(){function a(){return $.Deferred()}function b(a,b){if(!a||!Object.isObject(a))return b?$.Deferred().resolve(a).promise():a;var c,d;if(a.crypto&&(c=(e(a.crypto)||{key:null}).key),c||"cw"!=a._id||"settings"!=a.type||(c=a.pin,c&&!u&&(u=c)),!c)return b?$.Deferred().resolve(a).promise():a;if(d=Object.select(a,F),!b)return d.CRYPTO=cw.lib.encDoc(Object.reject(a,F),c),d;var f=$.Deferred();return cw.lib.encAsync(Object.reject(a,F),c).then(function(a){d.CRYPTO=a,f.resolve(d)}).fail(function(a){f.reject(a)}),f.promise()}function c(a,b,c){if(!A(a))return c?$.Deferred().resolve(a).promise():a;var d,f,g;if(a.hasOwnProperty(G)&&(a.crypto&&(d=(e(a.crypto)||{key:null}).key),d||"cw"!=a._id||(d=b)),!d)return c?$.Deferred().resolve(a).promise():a;if(!c){try{f=cw.lib.decDoc(a.CRYPTO,d),g=Object.reject(Object.merge(Object.clone(a,!0),f),G)}catch(b){return a}return g}var h=$.Deferred();return cw.lib.decAsync(a.CRYPTO,d).then(function(b){g=Object.reject(Object.merge(Object.clone(a,!0),b),G),h.resolve(g)}).fail(function(a){h.reject(a)}),h.promise()}function d(a,b){if(!a||!b)return a;var c;if((c=e(b))&&(c=c.key)){var d=cw.lib.blob2base64(a),f=cw.lib.base64(btoa(cw.lib.dec(d,c).from(1)),!0);return cw.lib.base642blob(f)}return a}function e(a){if(H[a])return H[a];H={};for(var b=t?t.keys:[],c=0;c<b.length;c++)H[b[c].id]=b[c];return H[a]||H}function f(a){return e(),H.hasOwnProperty(a)}function g(){var a,b=e(),c=[];return Object.keys(b).forEach(function(d){(a=b[d])&&a.name&&c.push({id:d,name:a.name+", "+a.emitter.split("-")[0]})}),c}function h(){return Object.merge({},E||{},!0)}function i(a){return a?Object.clone(D[a],!0):Object.keys(D)}function j(c,d,e){function f(a){var c=cw.lib.dry(t);return cw.lib.md5(c)===n?l.resolve("Nothing changed, no need to save"):(x(b(Object.merge(c,{crypto:"PIN",pin:v||c.pin}))).then(function(){k(),l.resolve("Settings saved sucessfully"),$&&$.my&&$.my.radio("settings.cw",Object.keys(C))}).fail(function(a){l.reject("Error saving settings")}),void 0)}if(z(c)&&null==d)return Object.merge({},D[c]||{},!0);if(z(c)&&z(d))return Object.clone(D[c][d],!0);if(null==c)return Object.merge({},D,!0);if(A(d)){var g,h,i,j=Object.clone(d,!0),l=a(),m=Object.clone(t,!0),n=cw.lib.md5(cw.lib.dry(t)),o=/^(http[s]?\:\/\/)[^\:@\/]+:[^@]+@(.+)(\/?)$/,p="apps ico pic name url title desc stamp start sync creatorhidden dataOnly readOnly autoCompact".split(" ").sort(),q={},s=[];if(t.type="settings",l.always(function(){t=m,C={};for(var a=0;a<t.dbs.length;a++)C[t.dbs[a].name]=t.dbs[a]}),"delete"==j._cmd)$.my.modal({manifest:"cw.Sys.Confirm",data:{text:['<div class="">',(j.url?I.MSG_DB_UNMOUNT:I.MSG_DB_DELETE).assign(j.name.escapeHTML()),"</div>"].join(""),ok:j.url?I.BTN_DB_UNMOUNT:I.BTN_DB_DELETE,cancel:I.BTN_CANCEL},css:"fs90 lh160"}).then(function(a){function b(a){return h.from(3)+"-"+cw.lib.crc2([a])}var c,d=[],e=new w(j.name),g=0==e._local,h=e._key;if(A(a)&&"commit"==a.cmd){for(var i=0;i<t.dbs.length;i++)t.dbs[i].name!==j.name?d.push(t.dbs[i]):c=Object.clone(t.dbs[i],!0);t.dbs=d;try{cw.db(j.name).sync(!1)}catch(a){}l.then(function(){if(Object.isArray(c.sync))for(var a=0;a<c.sync.length;a++)c.sync[a].dir.forEach(function(d){localStorage.removeItem(["","repl",d,b(c.sync[a].url)].join("_"))});g||new w(j.name).destroy().then(function(){cw.log("DB ‘"+j.name+"’ destroyed, reload scheduled."),window.location.reload()})}.debounce(500)),g?cw.log("Remote DB ‘"+j.name+"’ unmount confirmed, saving updated settings."):cw.log("Local DB ‘"+j.name+"’ deletion confirmed, saving updated settings."),f(t)}}).catch(function(){l.reject("DB deletion cancelled.")});else if("resync"===j._cmd)$.my.modal({manifest:"cw.Sys.Confirm",data:{text:'<div class=""><span class="fi-alert mr5 fs90 red"></span> DB resync requested. All content of current DB will be discarded on this device.  Removing local copy does not affect remote data, if any. When the process finishes, page reloads.</div>',ok:"Clean and resync DB"},css:"fs90 lh160"}).then(function(a){function b(a){return d.from(3)+"-"+cw.lib.crc2([a])}var c=new w(j.name),d=c._key;if(A(a)&&"commit"==a.cmd)if(0==c._local)l.reject("Can‘t resync remotely mounted bucket.");else{cw.log("Starting ‘"+j.name+"’ destroy+resync.");var e=C[j.name];for(g=0;g<e.sync.length;g++)e.sync[g].dir.forEach(function(a){localStorage.removeItem(["","repl",a,b(e.sync[g].url)].join("_"))});new w(j.name).destroy().then(function(){cw.log("DB ‘"+j.name+"’ destroyed for resync, reload scheduled."),window.location.reload()}.debounce(500))}}).fail(function(){l.reject("DB deletion cancelled.")});else if(C[j.name]){var u=C[j.name];for(g=0;g<u.sync.length;g++)h=u.sync[g].url.replace(o,"$1$2"),q[h]=u.sync[g].url;for(g=0;g<j.sync.length;g++)i=j.sync[g].url,i&&(i.indexOf("•••••")>-1?(h=q[i.replace(o,"$1$2")],h&&(j.sync[g].url=h,s.push(j.sync[g]))):s.push(j.sync[g]));(j.url&&r(j.url)!=j.url||u.url!=j.url)&&(C[j.name].url=j.url),C[j.name].sync=s.slice(0),Object.merge(C[j.name],Object.reject(Object.select(j,p),"sync")),f(t)}else j.name&&y(j.sync)&&j.title&&j.pic&&(t.dbs.push(Object.clone(Object.select(j,p))),f(t));return l.promise()}}function k(){t&&t.dbs&&t.dbs.length&&B(w._remap)&&w._remap(t.dbs.reduce(function(a,b){var c=b.url||"";return"/"==c[0]&&(c=(cw.root||"").replace(/\/$/,"")+c),a[b.name]=c,a},{}))}function l(a,b){return cw.lib.getref(C[a]||{},["sync",b,"url"])}function m(b){function d(a){var b,d=c(a,u);if(d.dbs&&d.uid||(d=c(a,v),d.dbs&&d.uid||(cw.log("Invalid PIN entered on start."),e.reject("Invalid PIN, can’t decrypt settings"))),d.dbs&&d.uid){E.name=d.name,E.pic=d.pic;try{if(d.pic.length>4e4){var f=new Image;f.src=d.pic,b=cw.lib.image(f),E.pic=b.sharpen(.5).resample(64,64).sharpen(.1).jpeg(.99)}}catch(a){E.pic=d.pic}E.uid=d.uid||cw.lib.hash8(d.name+cw.lib.hash8(d.pin)),E.contact=d.contact||"",E._id=["user",d.name,d.uid].join("-"),E.crc=cw.lib.hash8(d.pic+E._id+E.contact),E.roles=(cw.userCtx?cw.userCtx.roles:["_admin"]).slice(0),t=Object.merge({},d),k(),D={},C={};for(var g,h=0;h<t.dbs.length;h++){if(g=t.dbs[h].name,D[g]=Object.clone(t.dbs[h],!0),C[g]=t.dbs[h],y(D[g].sync))for(var i=0;i<D[g].sync.length;i++)D[g].sync[i].url=r(D[g].sync[i].url);z(D[g].url&&D[g].url)&&(D[g].url=r(D[g].url))}cw.debug||(J._getDbSettings=J._settings=J._settings=null,delete J._getDbSettings,delete J._getSyncUrl,delete J._settings),function(){e.resolve(Object.keys(D))}.delay(100)}}var e=a();return A(b)&&/^settings$/.test(b.type)&&b.name||e.reject("Invalid settings doc"),A(t)&&b._rev===t._rev?(e.resolve(Object.keys(D),!0),e.promise()):(b.CRYPTO&&!z(u)?c(b,o("",b.name)).uid?(u=n(""),v=o("",b.name),d(b)):$.my.modal({manifest:q(),width:320,close:!1,css:"15"}).always(function(a){A(a)?(u=n(a.pin),v=o(a.pin,b.name),d(b)):e.reject(I.PIN.ERR_NOPIN)}):(p(!0),d(b)),e.promise())}function n(a){return cw.lib.md5(cw.lib.md5(a)+cw.lib.hash8(a))}function o(a,b){return cw.lib.md5(n(a)+b)}function p(a){return a&&cw.userCtx&&y(cw.userCtx.roles)&&cw.userCtx.roles.find("_admin")?cw.debug=!0:cw.debug=!1}function q(){return{data:{pin:""},init:function(a){var b=this,c=Object.merge({title:"CloudWall",titleColor:"#60a9e6",logo:"logo.svg"},Object.select(cw.CW||{},["title","titleColor","logo"]));a.html($.my.formgen(['<div class="tac pt15">','<div class="dib vat w100p nw oh"><img class="pin-logo" src="'+c.logo+'"><div class="pin-nodetitle" style="color:'+c.titleColor+';">'+(c.title||"CloudWall").escapeHTML()+"</div></div>",{row:"320px",rowCss:"my-row pt15 tac"},["",'<input id="pin-pin" type="password" placeholder="{PLC_PIN}" class="w230 fs150 tac pt10 pb10 blue">'],["","btn#pin-btn-ok.fs105.pl20.pr20.mb25.br100.mt5",{val:"{BTN_DECRYPT}"}],'<div id="pin-logout" class="hide fs75 o70 xgray mb-5">',"{MSG_LOGGED_IN} ",'<i><span id="pin-username"></span></i>. ','<span id="pin-btn-logout" class="pseudolink tdn ml2">{BTN_LOGOUT}</span>. ',"</div>","</div>"]).assign(I.PIN)),a.find("#pin-pin").keydown(function(a){13==a.keyCode&&(p(!1),b.my.commit()),9==a.keyCode&&(a.preventDefault(),p(!0),b.my.commit())})},ui:{"#pin-pin":"pin","#pin-btn-ok":{bind:function(a,b,c){null!=b&&this.my.commit()},watch:["#pin-pin"],events:"click.my",css:{":disabled":function(a){return!a.pin}}},"#pin-logout":{css:{hide:function(){return!cw.root||!cw.userCtx}}},"#pin-username":function(){if(cw.userCtx)return cw.userCtx.name},"#pin-btn-logout":{bind:function(a,b){null!=b&&(cw.lib.note("Logging out..."),$.ajax({url:cw.root+"_session",data:JSON.stringify({name:"0",password:"0"}),method:"POST",dataType:"json",headers:{"Content-type":"application/json"}}).always(function(){location.reload()}.debounce(100)))},events:"click.my"}},style:{" .pin-logo":"max-width:40px;max-height:30px; display:inline-block; vertical-align:middle; margin-top:2px;"," .pin-nodetitle":["max-width:calc(100% - 40px); font-size:1.6em; line-height:1.3em; padding:0 0 2px 7px;","display:inline-block; vertical-align:middle;  overflow:hidden; text-overflow:ellipsis;"].join("")}}}function r(a){return a.replace(/^(http[s]?\:\/\/[^\:@\/]+:)[^@]+(@.+)$/,"$1•••••$2")}function s(a){var b={en:{BTN_CANCEL:"Cancel",BTN_DB_DELETE:"Remove bucket",MSG_DB_DELETE:['<span class="fi-alert mr5 fs90 red"></span> ','Bucket <span class="bolder">{1}</span> removal requested. ',"Please close all other tabs and browsers with CloudWall. ","Removing bucket on this machine does not remove it on linked machines’ accounts."].join(""),BTN_DB_UNMOUNT:"Unmount bucket",MSG_DB_UNMOUNT:['<span class="fi-alert mr5 fs90 orange"></span> ','Bucket <span class="bolder">{1}</span> unmount requested. ',"It’d be better to close all other tabs and browsers with CloudWall. ","Unmounting bucket does not remove remote data."].join(""),SYNC:{MSG_DLG:['<div class="">','<span class="fi-clock mr5 fs90 green"></span> Forced sync of the {1} bucket requested. ',"It can take a time, but you may continue working during process. ","On finish you’ll see notification.","</div>"].join(""),BTN_DLG_OK:"Force sync",BTN_DLG_CANCEL:"Cancel",MSG_SYNC_START:"Started forced DB replication.",MSG_CANCEL:"Bucket forced re-sync cancelled.",MSG_SYNC_OK:function(a,b,c){var d=c.split("@").last().replace(/^http[s]?:\/\//i,"");return"Forced sync of {1} bucket {2} {3} finished succesfully. Default sync interval restored.".assign(a.escapeHTML(),b,d.escapeHTML())},MSG_SYNC_FAIL:function(a,b,c){var d=c.split("@").last().replace(/^http[s]?:\/\//i,"");return"Forced sync of {1} bucket {2} {3} failed.".assign(a.escapeHTML(),b,d.escapeHTML())}},PIN:{PLC_PIN:"Enter PIN",BTN_DECRYPT:"Decrypt profile",MSG_LOGGED_IN:"Logged in as",BTN_LOGOUT:"Log out",ERR_NOPIN:"No PIN provided to decrypt settings"}},ru:{BTN_CANCEL:"Отмена",BTN_DB_DELETE:"Удалить БД",MSG_DB_DELETE:['<span class="fi-alert mr5 fs90 red"></span> ','Запрошено удаление БД <span class="bolder">{1}</span>. ',"Лучше закрыть все вкладки с CloudWall, запущенные с текущего домена. ","Удаление локальной реплики БД не удаляет данные на других устройствах."].join(""),BTN_DB_UNMOUNT:"Отключить БД",MSG_DB_UNMOUNT:['<span class="fi-alert mr5 fs90 orange"></span> ','Запрошено отключение БД <span class="bolder">{1}</span>. ',"Лучше закрыть все вкладки с CloudWall, запущенные с текущего домена. ","Отключение внешней БД не удаляет в ней данные данные."].join(""),SYNC:{MSG_DLG:['<div class="">','<span class="fi-clock mr5 fs90 green"></span> Запрошена принудительная синхронизация ','БД <span class="bolder">{1}</span>. ',"Это может занять некоторое время, однако во время репликации можно продолжать работу. ","По окончанию процесса вы увидите сообщение.","</div>"].join(""),BTN_DLG_OK:"Начать репликацию",BTN_DLG_CANCEL:"Отмена",MSG_SYNC_START:"Начата принудительная репликация.",MSG_CANCEL:"Репликация отменена.",MSG_SYNC_OK:function(a,b,c){var d=c.split("@").last().replace(/^http[s]?:\/\//i,""),e={from:"(загрузка из ",to:"(выгрузка в"}[b];return"Репликация БД {1} {2} {3}) завершена.".assign(a.escapeHTML(),e,d.escapeHTML())},MSG_SYNC_FAIL:function(a,b,c){var d=c.split("@").last().replace(/^http[s]?:\/\//i,""),e={from:"(загрузка из ",to:"(выгрузка в"}[b];return"Репликация БД {1} {2} {3}) не удалась.".assign(a.escapeHTML(),e,d.escapeHTML())}},PIN:{PLC_PIN:"Введите PIN",BTN_DECRYPT:"Войти",MSG_LOGGED_IN:"Вы авторизованы как",BTN_LOGOUT:"Выйти",ERR_NOPIN:"Не введён PIN, профиль не может быть расшифрован"}}};return I=$.extend(!0,{},b.en,b[a]||{}),I}var t,u,v,w=window.PouchDB,x=cw.profile,y=Object.isArray,z=(Object.isBoolean,Object.isString),A=Object.isObject,B=(Object.isNumber,Object.isRegExp,Object.isFunction),C={},D={},E={},F="type crypto stamp creator owners name pic tags parent _id _rev _attachments".split(" "),G="CRYPTO",H={},I=s($.my.locale()),J={enc:b.fill(),dec:c.fill(),keys:g.fill(),has:f.fill(),att:d.fill(),share:function(){},install:function(){},dblist:i.fill(),locale:s.fill(),me:h.fill(),_init:m.fill(),_getDbSettings:j.fill(),_getSyncUrl:l.fill(),_settings:function(){return t}.fill()};return J}()),function(cw,window){function _lock(a){return void 0!==a&&(cw.log(a?"Lock":"Unlock"),Lock.state=!!a,Lock.pi.notify(Lock.state)),{progress:Lock.pi.progress}}function _locked(){return Lock.state}function _pi(a){return $.Deferred()}function con(){_logger.apply(null,arguments),cw.debug&&console.log.apply(console,arguments)}function _rand8(){return Number.random(78364164096,2821109907455).toString(36)}function _note(a,b,c){var d=b||"";return $('<div class="'+d+'" style="display:none">'+a+"</div>").prependTo(CW.$notes).slideDown(100).delay(c||3e3).fadeOut(700,function(){$(this).remove()}),con((b?b+": ":"")+a),d}function _ee(){var a=new EE,b={on:function(c,d){return isS(c)&&isF(d)&&a.on(c,d),b},off:function(c,d){return!0===c?a.removeAllListeners():isS(c)&&!isF(d)?a.removeEvent(c):isS(c)&&isF(d)&&a.off(c,d),b},progress:function(c){return a.on("progress",c),b},notify:function(c,d,e){return a.emit("progress",c,d,e),b},trigger:function(c,d,e,f){return"string"!=typeof c?b:(a.emit(c,d,e,f),b)},emit:function(c,d,e,f){return"string"!=typeof c?b:(a.emit(c,d,e,f),b)}};return Object.freeze(b),b}function _qnotify(a){var b,c,d,e=[],f={};for(b in a)if(d=a[b].queue.length){e=a[b].queue.splice(0,d),a[b].revs={},a[b].idxs={},f[b]={};for(c in a[b].types)f[b][c]=[];for(c=0;c<e.length;c++)f[b][""].push(e[c]),void 0!==f[b][e[c].type]&&void 0!==e[c].type&&f[b][e[c].type].push(e[c]);for(c in a[b].types)f[b][c].length||delete f[b][c]}for(b in f)for(c in f[b])a[b].types[c].notify(f[b][c])}function _qchanged(a,b,c){var d,e=a._db;return a.type&&a._db&&a._id&&a._rev?(d=b[e],d.revs[a._id]?(d.queue[d.idxs[a._id]]=a,d.revs[a._id]=a._rev):(d.idxs[a._id]=d.queue.push(a)-1,d.revs[a._id]=a._rev),c(),void 0):null}function i20n(a){return a in lang?lang[a]:a}function setLocale(a){return Object.merge(lang,lang.en,!0),lang[a]&&Object.merge(lang,lang[a],!0),lang._LANG=lang,cw.crypto.locale(a),cw.localizePlugins(a),lang[a]}function _encrypt(a,b){return cw.crypto.enc(lib.dry(a),b)}function _decrypt(a,b){return cw.crypto.dec(a,void 0,b)}function _register(a,b){var c,d,e,f,g,h,i,j,k="cw",l=a;if(isS(b)&&(k=b),!isO(l))return null;if(i=$.my.cache(l,b&&"cw"!==b?forms[k]:void 0),!i)return null;if(!(j=l.app)||!l.id||!j.name)return null;if(con("Received app "+l.id+" from "+k+", _rev is "+l._rev),dbapps[k][j.name]||(dbapps[k][j.name]={}),Object.merge(dbapps[k][j.name],{name:j.name,id:l.id,pic:l.pic||j.ico,ico:j.ico||l.pic,title:j.title,author:j.author,isEditor:!!j.nodecmd,types:j.types?Object.clone(j.types,!0):{}}),isO(l.app.types)&&Object.size(l.app.types)){h=l.app.types,g=l.id;for(e in h)for(types[k][e]||(types[k][e]={}),c=types[k][e],f=0;f<h[e].length;f++)c[h[e][f]]||(c[h[e][f]]=[]),d=c[h[e][f]],d.indexOf(n)===-1&&d.push(g),c[h[e][f]]=d.unique();if("cw"!==k)Object.merge(types[k],types.cw,!0);else for(e in types)"cw"!==e&&Object.merge(types[e],types.cw,!0)}return cw.event("app manifest update"),i}function _urlObserverStart(a){function b(){if(!cw.locked()){var a,b=(window.location.hash+"").replace(/^#+/,""),c=cw.state.get();c?a=c.url||"":""==a,c&&(b===a||b===c.initurl)||"undefined"===b||"null"===b||""===b||(cw.log("URL address bar hash changed: ",b),cw.state.set(b).fail(function(a,b){window.location.hash=apps.active||CW.appDefault}))}}$(window).on("hashchange.cw",b.debounce(1e3/60+3)),null!=a&&(location.hash=a+""),$(window).trigger("hashchange")}function _readsaver(){function a(a){read[a]._db="cw",sys.save(read[a],!0).then(function(a){con(a.db+": Saved read state to system db."),read[a.db]._rev=a._rev,read[a.db]._dirty=0},function(b,c){con(read[a]._db+": Failed to save state."),con(b,c)})}Object.keys(read).forEach(function(b){read[b]._dirty&&"cw"!=b&&sys.get(read[b]._id).then(function(c){c._rev!=read[b]._rev&&_cmpreads(b,c),a(b)}).catch(function(c){"404"==c.status&&a(b)})})}function _cmpreads(a,b){var c,d,e,f=a,g=[],h=[],i=[],j=read[f].hidden,k=read[f].read,l=read[f].trust||{},d=b.hidden,e=b.read,m=b.trust||{};for(c in d)d[c]!=j[c]&&(read[f].hidden[c]=d[c],g.push(c));for(c in e)k[c]&&k[c].rev===e[c].rev||(read[f].read[c]=e[c],h.push(c));for(c in m)l[c]&&l[c].rev===m[c].rev||(read[f].trust[c]=m[c],i.push(c));if(con(a+": New hide/read lists ",g,h),g.length)for(c in g)dbs[f].hide(g[c]);if(h.length)for(c in h)dbs[f].markread(h[c]);read[f]._rev=b._rev}function _ReadHideListDoc(a){return{_id:"db-"+a+"-read",_dirty:0,db:a,type:"readhidelist",name:a+" readstate",read:{},hidden:{},trust:{}}}function _cache(a){var b=a;if(!(isO(b)&&b._db&&b._id&&b._rev))return null;read.hasOwnProperty(b._db)||(read[b._db]=_ReadHideListDoc(b._db));var c,d,e=read[b._db].read,f=read[b._db].hidden,g=ram[b._db];if(b.crypto&&b.CRYPTO&&(cw.crypto.has(b.crypto)||(b._nokey=!0)),f[b._id]||b.parent&&f[b.parent]?b._hidden=!0:!f[b._id]&&b._hidden&&(f[b._id]=!0,read[b._db]._dirty||(read[b._db]._dirty=0),read[b._db]._dirty++),e[b._id]?e[b._id]&&(b._read&&1*b._read.split("-")[0]>1*e[b._id].rev.split("-")[0]?(e[b._id].rev=b._rev,e[b._id].stamp=Date.now(),read[b._db]._dirty||(read[b._db]._dirty=0),read[b._db]._dirty++):e[b._id].rev===b._rev?b._read=b._rev:b._read=""):b._read===b._rev?(e[b._id]={rev:b._rev,stamp:Date.now()},read[b._db]._dirty||(read[b._db]._dirty=0),read[b._db]._dirty++):b._read="",c=g[b._id]){if("manifest"!==b.type&&c._rev===b._rev&&c._read===b._read&&c._hidden==b._hidden&&c._full==b._full&&c._nokey==b._nokey)return c;for(d in g[b._id])delete g[b._id][d]}else ram[b._db][b._id]=Object.extended();if(b._tags={},isA(b.tags))for(d=0;d<b.tags.length;d++)(isS(b.tags[d])||isN(b.tags[d]))&&(b._tags[b.tags[d]]=!0);if(isO(b.otags))for(d in b.otags)b._tags[d]=!0;if(g[b._id].merge(b),Object.merge(tags[b._db],b._tags,!0),"manifest"==b.type&&b.manifest&&b.manifest.id&&!_dbsettings(b._db,"dataOnly")){var h=lib.fuse({},b.manifest,{_id:b._id,_rev:b._rev,_db:b._db});b._attachments&&(h._attachments=b._attachments,delete appfiles[b._db][b._id]),"cw"===b._db?_register(h,"cw"):b.beta&&b.creator!==me.name&&(!isA(b.log)||b.log[0][2]!==me.name+"-"+me.uid&&b.log.last()[2]!==me.name+"-"+me.uid)||(read[b._db].trust[b._id]!==b._rev&&"*"!==read[b._db].trust[b._id]?Object.merge(h,{_notrust:!0}):Object.merge(h,{_notrust:!1}),_register(h,b._db))}return"user"===b.type&&(users[b._db][b.name+"-"+b.uid]=b.pic),"settings"===b.type&&"cw"===b._db&&"cw"===b._id&&_initCrypto(b).then(function(a,b){b||(con("Received settings update"),_processSettings.delay(2))}),_docChanged(g[b._id]),g[b._id]}function _uncache(a,b){return ram[a]&&ram[a][b]&&!ram[a][b]._hidden?(_docChanged({_deleted:!0,_db:a,_id:b,_rev:ram[a][b]._rev,type:ram[a][b].type}),delete ram[a][b]):null}function _processSettings(a){function b(b){var d=_pi(),h=dbs[b],i=cw.crypto.dblist(b);return d.then(function(){g()}),h?(h.sync(!1),function(){h.sync(!0)}.delay(1e3),e.push(b),"cw"==b&&(sys=h),d.resolve()):(b!=a&&"cw"!=b?(f+=1,_connect(b,300*f+300,!!i.autoCompact)):_connect(b,0,!!i.autoCompact)).then(function(a){(function(){try{a.sync(!0)}catch(a){con(a)}}).delay(300*f+700),"cw"==b?(sys=a,_dbsettings(b).dataOnly?(e.push(a.name),d.resolve()):sys.load("cw-","cwz","manifest").then(function(b){e.push(a.name),con("System core apps read"),d.resolve()}).fail(function(){c.reject(0,"Loading core apps failed")})):(e.push(a.name),d.resolve())}.fill(void 0,f)).fail(function(a,b){_note(b,"error"),d.resolve()}),d.promise()}var c=_pi(),d=cw.crypto.dblist(),e=[],f=0;if(Object.merge(me,cw.crypto.me()),con("User for session "+Session+" is "+me.name+"-"+me.uid),CW.$upic&&me.pic&&(isS(CW.$upic)?$(CW.$upic).attr("src",me.pic):CW.$upic.attr("src",me.pic)),d.length&&me.name){c.then(function(){cw.event("settings update"),$.my.radio("settings.cw",d.slice(0))});var g=function(){con("All local DBs connected"),c.resolve(e)}.after(d.length);(function(){c.resolve(!0)}).delay(CW.dbConnTimeout),b(d[0]).then(function(){d.from(1).forEach(b)})}else c.reject(0,"Invalid settings");return c.promise()}function _dbsettings(a,b,c){return _getDbSettings(a,b,c)}function _acl(a,b,c,d){function e(a,b,c){return a.findAll(a=>!a[b]||!a[b].length||a[b].indexOf("*")>-1||a[b].indexOf(c)>-1)}function f(a,b,c){return a.findAll(function(a){var d=a[b],e="",f=0;if(!d||!d.length)return!1;for(;f<d.length&&!e;f++)("*"==d[f]||c[d[f]])&&(e=d[f]);return!!e})}if(!isS(a)||!dbs[a])return null;var g=cw.lib.a2o(me.roles),h=me.name,i=f(CW.acl,"roles",g),j=e(i,"users",h),k=e(j,"dbs",a);if(b){var l=e(k,"apps",b).reduce(function(a,b){return Object.keys(b.types||{}).forEach(c=>a[c]=(a[c]||[]).union(b.types[c])),a},{});if(!c)return l;if(!l["*"]&&!l[c])return!d&&[];var m=(l["*"]||[]).union(l[c]||[]);return d?!!(m.indexOf(d)>-1||m.indexOf("*")>-1):m}var n=["cw",a].reduce(function(a,b){return Object.keys(dbapps[b]).reduce(function(a,c){var d=dbapps[b][c];return a[c]=a[d.name]=a[d.id]=a[d.id.replace(/^[^.]+\./,"")]=d.types,a},a),a},{}),o=k.reduce(function(a,b){return(b.apps||[]).forEach(c=>a[c]=b.types||{}),a},{}),p=(o["*"]||{},cw.lib.getref(o,["*","*"])||[]),q=p.indexOf("*")>-1;return Object.keys(o).reduce(function(a,b){var c={};return n[b]?Object.keys(n[b]).reduce(function(a,c){var d=o[b][c]||[];return d.length||p.length?(p.length?q?a[c]=p:a[c]=n[b][c].intersect(p.union(d)):d.indexOf("*")>-1?a[c]=n[b][c]:a[c]=n[b][c].intersect(d),a[c]&&!a[c].length&&delete a[c],a):a},c):c=o[b],a[b]=c,a},{})}function _ajax(a,b){var c,d,e=sys.ram(CW.pluginSetDoc)[0];if(e&&(c=e._attachments)&&(d=isS(a)?a:(a||{}).url,d&&!/^http[s]?:\/\//.test(d)&&(d=d.split("/").last(),c[d]))){var f=_pi();return sys.att(CW.pluginSetDoc).data(d).then(function(a){var b,c=a[d].data;try{b=decodeURIComponent(escape(window.atob(c)))}catch(a){b=null}if(b){try{window.eval(b),con("Started local "+d)}catch(a){con("Error starting local "+d,a.message),f.reject(lang.ERR_LOCALLIB.assign(d.escapeHTML()))}f.resolve(null)}else f.resolve(null)}),f.promise()}return $.ajax.apply(this,Array.prototype.slice.call(arguments))}function _startCloudwall(){function a(){delete cw.login,cw.debug?cw.forms=forms:(delete cw.crypto._getSyncUrl,delete cw.crypto._getDbSettings,delete cw.crypto._init,delete window.PouchDB,delete cw.pouch,delete cw.CW,delete cw.reg,delete cw.start,delete cw.lock,delete cw.read,delete cw.profile,delete cw.buildDOM,delete cw.localizePlugins,delete $.my.ajax),Object.freeze(cw.state),Object.freeze(cw.userCtx.roles),Object.freeze(cw.userCtx),Object.freeze(cw),window.onbeforeunload=function(){var a=cw.state.slots(),b=0;for(var c in a){var d=a[c].app,e=a[c].$app.my("data");d.isEditor()&&d.crcdoc!==lib.footprint(lib.getref(e,d.nodedoc))&&(b+=1)}return cw.log("~~~ Tab close "+(b?"requested, some docs are unsaved":"")+" ~~~"),b?lang.MSG_UNLOAD:void 0},g.resolve(dbs)}function b(){con("Start url observers and savers");var a=_pi();window.location.hash&&"#"!==window.location.hash||(window.location.hash=CW.appDefault);try{setInterval(_readsaver,CW.readStateSaverInterval),_urlObserverStart(window.location.hash.replace(/^#/,""))}catch(b){a.reject(0,"Observers start failed"),console.log(b)}return a.resolve(),a.promise()}function c(){var a=_pi(),b=function(){a.resolve()};try{cw.buildDOM()}catch(b){return a.reject(0,"DOM start failed: "+b)}return CW.$nav.my(CW.appNav,{},{}).then(b).fail(function(b,c){con(b,c),a.reject(0,"Error starting dock")}),a.promise()}function d(){var a=_pi();return a.then(function(){$(".cw-Runtime").removeClass("hide"),$(".cw-Static").addClass("hide").html(""),$("#cw-body").addClass("cw"),CW.maxSpaceWidth=Math.max($("body").width()-CW.margins,CW.defaultSpaceWidth)}).fail(function(){}),_profile().then(function(b){con("Settings doc read"),_initCrypto(b).then(function(){con("Settings doc decoded"),a.resolve()}).fail(function(b){a.reject(0,b,"Invalid PIN, access denied")})},function(){a.reject(1,"No settings file")}),a.promise()}function e(){var a=_pi();return f=new Pouch("cw").then(function(b){sys=b,function(){a.resolve(b)}.delay(1),con("Connected to cw")},function(b){a.reject(0,"Fail to connect System DB"),console.log(b)}),a.promise()}var f,g=_pi(),h=window.location.hash.replace(/^#/,"").split("/")[0]||"cw";return _getSyncUrl=cw.crypto._getSyncUrl,_getDbSettings=cw.crypto._getDbSettings,_initCrypto=cw.crypto._init,_profile=cw.profile,_parseURL=cw.parseURL,setLocale($.my.locale()),delete cw.crypto._settings,e().then(d).then(function(){return _processSettings(h)}).then(c).then(b).then(a).fail(function(a,b){_note(b,"error"),g.reject(b)}),g.promise()}var VERSION="2.4.1";const Pouch=window.PouchDB,EE=window.EventEmitter,lib=cw.lib,$E=$.extend,n=function(a){return null!==a&&void 0!==a},nn=n,N=null,FN=function(){},ls=window.localStorage,d8="{yyyy}-{MM}-{dd}",h24="{HH}:{mm}",Ob="object",Da="data",Ar="array",St="string",Fu="function",isA=Object.isArray,isB=Object.isBoolean,isS=Object.isString,isO=Object.isObject,isN=Object.isNumber,isR=Object.isRegExp,isF=Object.isFunction,isP=function(a){return!(null==a||!isO(a)&&!a.jquery||!isF(a.then))},isRej=function(a){return isP(a)?"rejected"===a.state():null};var Session=lib.hash4(Date.now()+" "+Number.random(1e5,1e6)),CW=$E(!0,{title:"CloudWall",logo:"logo.svg",titleColor:"#589fe6",profile:"cw/cw",profileWritable:!0,acl:[{dbs:["*"],roles:["*"],users:["*"],apps:["*"],types:{}}],appRepos:["cw"],appDefault:"cw/Sys.Hub",pluginSetDoc:"cw-Sys-Plugins-4vx1",storageSalt:"",syncRestart:21e3,batchSize:5,$body:"#cw-body",$space:"#cw-space",$upic:"#cw-upic",$notes:"#cw-notes",minBodyWidth:900,margins:40,defaultSpaceWidth:1200,$slots:"#cw-slots",$nav:"#cw-header",appNav:"cw.Sys.Dock",appTrust:"cw.Sys.Trust",slotTimeout:3e3,slotCloseTimeout:60,slotLayoutDelay:110,slot:'<div class="cw-app"></div>',
appToUrlTrackerDebounce:150,urlObserverInterval:333,readStateSaverInterval:15e3,dbWatchersDebounce:5,appNameMask:/^[A-Z][A-Za-z0-9]{1,24}(\.[A-Za-z0-9]{1,25}){0,4}$/,appUpdateURL:"cw/apps.json",dbConnTimeout:3e4,gcAttsInterval:6e5},cw.CW||{}),lang={en:{BTN_OK:"Ok",BTN_CANCEL:"Cancel",MSG_UNLOAD:"Some docs are not saved. Proceed?",ERR_LOCALIB:"Error initializing local lib {1}",ERR_CONNFAIL:"Connection to DB {1} failed. {2}.",ERR_DBNOCONN:"External bucket is unreacheable",ERR_NODELSETTINGS:"Settings can not be deleted",ERR_DOCDELFAIL:"Failed to delete doc {1}",ERR_DOCNOEXIST:"Doc {1} doesn’t exist.",MSG_CONFLICT:"Conflict: document was updated externally while edit. Saving doc will overwrite external changes.",BTN_CONFLICT:"Overwrite",ERR_OWR_READ:"Conflict on doc {1}. Overwrite failed reading new revision id.",ERR_SAVE_DBFAIL:"DB failed on doc {1}. Save aborted.",ERR_SAVE_ENCRYPT:"Error encrypting doc {1}. Save aborted.",ERR_SAVE_READONLYDB:"Doc {1} was not saved, bucket is read-only.",ERR_SAVE_NODOC:"No doc to save.",ERR_SAVE_NAMETYPE:"Doc must have .name and .type fields non-empty.",ERR_SAVE_PRENC:"Cannot save pre-encrypted doc.",MSG_CONFLICT_CANCEL:"Conflict on doc {1}. Save cancelled.",ERR_SLOTPARAMS:"Invalid params for slot switch.",ERR_SLOTPARAMST:"Invalid params type for slot switch.",ERR_SLOTAPP_ACL:"App is not allowed for the bucket.",ERR_SYSLOCKED:"System is locked.",ERR_LOAD_FAIL:"Loading doc {1} failed.",ERR_NODOC:"Doc {1} was not found in {2} bucket.",ERR_NOKEY:"Doc {1} is encrypted with key {2}, which is not present.",ERR_DECRYPT:"Error decrypting doc {1}",ERR_CMDAPP:"App {1} can’t {2} doc of type {3}.",ERR_NOQRIES:"Can’t create DB queries for app {1}.",ERR_APPINIT:"App {1} init failed. {2}",ERR_APPINIT_TIMEOUT:"App {1} init time out.",ERR_DECAFTERSAVE:"Error decoding doc after save.",MSG_UNSAVED:"Doc has unsaved changes.",BTN_UNSAVED_OK:"Save and close",BTN_UNSAVED_NO:"Discard and close",ERR_SAVE_FAIL:"Failed saving doc {1}",TXT_CLOSECANCEL:"App close cancelled"},ru:{BTN_OK:"ОК",BTN_CANCEL:"Отмена",MSG_UNLOAD:"Некоторые документы не сохранены. Закрыть?",ERR_LOCALIB:"Error initializing local lib {1}",ERR_CONNFAIL:"Подключение к {1} не удалось. {2}.",ERR_DBNOCONN:"Внешняя БД недоступна для подключения",ERR_NODELSETTINGS:"Настройки нельзя удалить",ERR_DOCDELFAIL:"Документ {1} не был удалён",ERR_DOCNOEXIST:"Документ {1} не существует.",MSG_CONFLICT:"Конфликт версий: документ был обновлён пока вы его редактировали. Сохранение вашей версии перезапишет эти обновления.",BTN_CONFLICT:"Перезаписать",ERR_OWR_READ:"Конфликт при записи {1}. Перезапись не удалась, сбой чтения конфликтующего документа.",ERR_SAVE_DBFAIL:"БД не смогла сохранить {1}.",ERR_SAVE_ENCRYPT:"Ошибка зашифровки документ {1}. Документ не сохранён.",ERR_SAVE_READONLYDB:"Документ {1} не сохранён, БД разрешает только чтение.",ERR_SAVE_NODOC:"Нет документа для сохранения.",ERR_SAVE_NAMETYPE:"Документ должен иметь непустые поля name и type.",ERR_SAVE_PRENC:"Пред-зашифрованные документы сохранять запрещено.",MSG_CONFLICT_CANCEL:"Конфликт версий документа {1}. Сохранение отменено.",ERR_SLOTPARAMS:"Неверные параметры запуска приложения.",ERR_SLOTPARAMST:"Неверный тип параметра для запуска приложения.",ERR_SLOTAPP_ACL:"Приложение не может работать в этой БД.",ERR_SYSLOCKED:"Система в блокировке.",ERR_LOAD_FAIL:"Загрузка документа {1} не удалась.",ERR_NODOC:"Документ {1} не найден в БД {2}.",ERR_NOKEY:"Документ {1} зашифрован ключом {2}, этот ключ не найден в вашем профиле.",ERR_DECRYPT:"Ошибка расшифровки документа {1}, возможно, данные повреждены.",ERR_CMDAPP:"Приложение {1} не может применить команду “{2}” с документу типа “{3}”.",ERR_NOQRIES:"Невозможно создать хранимые запросы к БД {1}.",ERR_APPINIT:"Старт приложения {1} не удался. {2}",ERR_APPINIT_TIMEOUT:"Лимит времени на запуск приложения {1} исчерпан.",ERR_DECAFTERSAVE:"Ошибка расшифровки после сохранения.",MSG_UNSAVED:"В документе есть несохранённые правки.",BTN_UNSAVED_OK:"Сохранить и закрыть",BTN_UNSAVED_NO:"Не сохранять",ERR_SAVE_FAIL:"Ошибка при сохранении документа {1}",TXT_CLOSECANCEL:"Закрытие приложения отменено"}},Lock={pi:_ee(),state:!1},$body=$("body"),sys,apps={},forms={cw:{_src:{},_name:"System manifest cache"}},dbapps={cw:{}},appfiles={cw:{}},dbs={},me={type:"user",name:"",pic:"",uid:"",contact:"",crc:"",_id:"",roles:[],locale:(window.navigator.language+"").split("-")[0]||"en"},ram={},tags={cw:{}},state={},types={cw:{}},users={},read=Object.extended(),watchers=Object.extended(),_notifyWatchers,_connect,_Events=_ee(),_docChanged,_getSyncUrl,_getDbSettings,_parseURL,_initCrypto,_att,_logger,_profile,TMP;cw.TMP||(cw.TMP={}),isF(cw.session)?Session=cw.session():cw.session=function(){return Session},_logger=isF(cw.log)?cw.log:console.log.bind(console),con("~~~ Started session "+Session+" ~~~"),cw.event=function(a,b,c){return isF(a)?_Events.progress(a):isS(a)&&_Events.notify(a,b,c),_Events},_notifyWatchers=_qnotify.fill(watchers).debounce(CW.dbWatchersDebounce),_lock().progress(function(a){a||_notifyWatchers()}),_docChanged=_qchanged.fill(void 0,watchers,function(){_locked()||_notifyWatchers()}),cw.form=function(a,b){function c(a,b,c){if(!e&&CW.appNameMask.test(b)&&b.length<130)for(var d in a)!e&&a[d].hasOwnProperty("app")&&a[d].app.name===b&&(e=$.my.cache(d,c));return e}var d,e=null,f=a;return isS(a)&&a&&(cw.debug?(isS(b)&&dbs[b]&&(d=forms[b]._src,d[a]?e=$.my.cache(a,forms[b]):a.has("/")&&(f=a.split("/")[1]),e=c(d,f,forms[b])),e||(d=$.my.cache(),d[a]?e=$.my.cache(a):a.has("/")&&(f=a.split("/")[1]),e=c(d,f))):(d=$.my.cache(),d[a]?e=$.my.cache(a):a.has("/")&&(f=a.split("/")[1]),e=c(d,f),!e&&isS(b)&&dbs[b]&&(d=forms[b]._src,d[a]?e=$.my.cache(a,forms[b]):a.has("/")&&(f=a.split("/")[1]),e=c(d,f,forms[b])))),e},function(a){function b(a,b){function d(a,b){_lock(!0);var d=c.slot[a];if(d){for(var e in d.attctr)d.attctr[e]>0&&_att(d.db.name,e).free(d.attctr[e]+1);d.db&&Object.values(d.db.watch()).forEach(function(a){a.off(!0)})}c.status[b].off&&c.status[b].off(!0),delete c.status[b],delete c.slot[a];var f,h=CW.$slots.find("#"+b);try{f=$.extend(!0,{},h.my("remove"),!0)}catch(a){}h.remove(),cw.log("App "+d.url+" closed"),d=null,_lock(!1),cw.event("slot close"),g.resolve(f)}var e,f,g=_pi();if(f=c.slot[a])if(e=f.domid,f.closing=!0,cw.log("Closing "+f.url),c.active!==a)c.status[e].notify("close"),d.delay(CW.slotCloseTimeout,a,e);else{var h=0,i="";for(var j in c.slot)j!==a&&c.slot[j].app.updated>h&&(h=c.slot[j].app.updated,i=j);h||(i=CW.appDefault),c.status[e].notify("close"),_lock(!0),CW.$slots.find("#"+e).animate({opacity:.3},CW.slotCloseTimeout-15,null,function(){var b=window.location.href.split("#")[0]+"#"+i;window.history.replaceState(null,null,b),_lock(!1),cw.state.set(i).always(function(){d.delay(CW.slotCloseTimeout,a,e)})})}return g.promise()}var c=(_pi(),Object.merge(apps,{slot:{},active:"",status:{}}));Object.merge(a,{get:function(){return c.slot[c.active]},slots:function(a){return isS(a)?c.slot[a]:c.slot},url:function(){return c.active},set:function(a,d){function e(){var a,b=_pi();return z="cw-app-"+_rand8(),A=$(CW.slot),A.attr("id",z),u=cw.layout(y,!1),A.addClass("cw-app-init").width(u.slot),A.prependTo(CW.$slots),a=c.slot[t.initurl]={$app:A,domid:z,started:Date.now(),attctr:0,name:y.app.name,db:null,app:y.app,url:t.url,initurl:t.initurl,initstate:t.initstate,notify:function(a,b){B.notify(a,b)}.debounce(0),width:u,title:lib.mask(y.data,y.app.nodetitle)||y.app.title,busy:!0,state:"init",isEditor:!!t.cmd},A.data("app",a),$.my.radio("slot.cw",{domid:z,event:"start.dominit"}),b.resolve(),b.promise()}function f(){var a,b,c,d,e=_pi(),f=!1,g={},h=[];if("cw"===y._db)e.resolve();else{read[t.db].trust||(read[t.db].trust={},f=1),c=read[t.db].trust,b=(d=w.ram(function(a){return"manifest"===a.type&&a.manifest&&(a.manifest.id===t.appid||a.manifest.id.startsWith(t.appid+"."))})).reduce(function(a,b){return a[b._id]=b._rev,g[b._id]=b,a},{});for(a in b)"*"!==c[a]&&c[a]!==b[a]&&h.push({id:g[a].id,_id:g[a]._id,_rev:g[a]._rev});h.length?(cw.log("Confirm trust modal"),$.my.modal({manifest:CW.appTrust,data:{trust:h.sortBy("id")}}).then(function(a){if(isO(a)){for(var b=0;b<a.trust.length;b++)c[a.trust[b]._id]=a.trust[b]._rev;for(a.trust.length&&(read[t.db]._dirty=!0),cw.lib.unjson(y),b=0;b<h.length;b++){var d=Object.clone(ram[y._db][h[b]._id],!0);_cache(d)}cw.log("Trust confirmed"),e.resolve()}else e.reject(1,"App start terminated by user.")}).fail(function(){cw.log("App trust rejected by user"),e.reject(1,"App start terminated by user.")})):e.resolve()}return e.promise()}function g(){function a(a,d){c.slot[t.initurl].state="docready",$.my.radio("slot.cw",{domid:z,event:"start.docready"}),b.resolve(a,d)}var b=_pi();if(t.cmd)if("create"!=t.cmd||t.oldid){var d=ram[t.db][t.oldid||t.docid];d?(w.markread(d._id),a(d,"isInvalid")):w.load([t.oldid||t.docid]).then(function(b){a(b[0],"isInvalid")}).fail(function(){b.reject(1,lang.ERR_LOAD_FAIL.assign((t.oldid||t.docid).escapeHTML()))})}else!function(){var b={type:t.doctype,_id:t.docid};a(b,"isAppCapable")}();else b.resolve(null,"getAppResources");return b.promise()}function h(){function a(a,b){return a.split(/\D/).compact(!0).slice(0,b||1e6).map(a=>parseInt(a)).reverse().reduce(function(a,b,c){return a+=b*Math.pow(10,4*c)},0)}function b(b){var g=b||{_id:"_design/"+d,language:"javascript",version:"0.0",views:{}};if(a(g.version||"0.0",2)>=f)return c.resolve();var h=cw.lib.json(y.queries);return h==JSON.stringify(g.views)?c.resolve():(g.views=JSON.parse(h),g.version=e,g.stamp=Date.now(),w.put(cw.lib.dry(g)).then(function(){c.resolve()}).catch(function(b){a(g.version||"0.0",2)>=f?c.resolve():c.reject(1,lang.ERR_NOQRIES.assign(y.app.name.escapeHTML()))}),void 0)}var c=_pi();if(!isO(y.queries)||!Object.size(y.queries))return c.resolve().promise();var d=y.id.from(3).replace(/\./g,"-"),e=y.app.version+"."+y.app.build,f=a(e,2),g=w.ram("_design/"+d)[0];return g?b(Object.clone(g,!0)):w.load("_design/"+d).then(function(a){b(a)}).fail(function(a){b()}),c.promise()}function i(a,b){var c=_pi();return b&&"isInvalid"!=b?c.resolve(a,b).promise():a?a._nokey?c.reject(1,lang.ERR_NOKEY.assign((a.title||a.name||a._id).escapeHTML(),a.crypto)).promise():a.crypto?(_decrypt(a,!0).then(function(a){c.resolve(a)}).fail(function(b){c.reject(1,lang.ERR_DECRYPT.assign((a.title||a.name||a._id).escapeHTML()))}),c.promise()):c.resolve(a).promise():c.reject(1,lang.ERR_NODOC.assign((t.oldid||t.docid).escapeHTML(),w.name.escapeHTML())).promise()}function j(a,b){var d=_pi();if(b&&"isAppCapable"!=b)return function(){d.resolve(a,b)}.delay(1),d.promise();var e,f=a.type;return t.cmdtypes.indexOf(f)>-1||t.cmdtypes+""=="*"?(e=$.extend(!0,{},a),"create"==t.cmd&&(e._rev?(delete e._rev,e._cloned=t.oldid,e._id=cw.uuid()):e._id=t.docid),Object.merge(y.data,lib.unmask(e,y.app.nodedoc),!0),Object.merge(c.slot[t.initurl],{title:lib.mask(y.data,y.app.nodetitle)||y.app.title},!0),$.my.radio("slot.cw",{domid:z,event:"start.docload"}),d.resolve(a)):d.reject(1,lang.ERR_CMDAPP.assign(y.app.name.escapeHTML(),t.cmd.escapeHTML(),f.escapeHTML())),d.promise()}function k(a,b){var c,d,e,f=_pi();return b&&"getAppResources"!=b?(f.resolve(a,b),f.promise()):(y._attachments&&y._id&&y._db?(c=y._attachments,d=y._db,e=y._id,appfiles[d][e]?(y.files=Object.clone(appfiles[d][e]),f.resolve(a)):(appfiles[d][e]={},_att(d,e).url(),_att(d,e).data().then(function(b){appfiles[d][e]=b,y.files=Object.clone(appfiles[d][e]),f.resolve(a)}).fail(function(){f.resolve(a)}))):f.resolve(a),f.promise())}function l(){var a=_pi();return Object.merge(y.data,t.stateobj,!0),Object.merge(y,{params:{cache:function(a){return dbs[t.db].form(a)}}},!0),B=_ee(),B.progress(function(a,b){var d,e,f;if(d=c.slot[b])if("active"==a){F=!0,c.active=b,e=d.app,f=cw.layout(e,!1),cw.layout(d,f),d.app.updated=Date.now(),A.removeClass("hide cw-app-init").addClass("cw-app-active");try{A.my("restyle")}catch(a){console.log(a)}cw.event("slot open")}else"inactive"==a?($.my.modal(!0),F=!1,A.removeClass("cw-app-active").addClass("hide")):"close"==a&&c.active==b&&$.my.modal(!0)}.fill(void 0,t.initurl)),c.status[z]=B,y=q(y,w,B,t),G=y.app.isEditor(),a.resolve(y),a.promise()}function m(a){var b=_pi();return E?b.reject(1,lang.ERR_APPINIT.assign(s.truncate(50).escapeHTML())):(function(){"pending"==D.state()&&r(0,lang.ERR_APPINIT_TIMEOUT.assign(s.truncate(50).escapeHTML()))}.delay(1*a.app.timeout||CW.slotTimeout),cw.log("Init $.my "+a.id),A.my(a).then(function(){cw.log("Started "+a.id),c.slot[t.initurl].busy=!1,c.slot[t.initurl].state="appstart",$.my.radio("slot.cw",{domid:z,event:"start.appstart"}),b.resolve()},function(a,c){b.reject(a,lang.ERR_APPINIT.assign(s.escapeHTML(),isS(a)?a:isS(c)?c:""))})),b.promise()}function n(){var a,b=_pi(),a=Object.merge(c.slot[t.initurl],{attctr:H,name:y.app.name,busy:!1,db:y.db,title:lib.mask(y.data,y.app.nodetitle)||y.app.title,state:"running"},!0);return v=c.slot[c.active]?c.slot[c.active].domid:null,v&&v!==z&&c.status[v].notify("inactive"),B.notify("active"),b.resolve(a),b.promise()}function o(a){function b(){if(G){var a=y.app.crcdoc;try{a=lib.footprint(lib.getref(A.my("data"),y.app.nodedoc))}catch(a){}y.app.crcdoc==a&&y.app.crccurr==a||(y.app.crccurr=a,$.my.radio("slot.cw",{domid:y.domid,event:"crc"}))}}var c=_pi(),d=b.debounce(4*CW.appToUrlTrackerDebounce);return A.on("change.my",function(){if(F&&A.hasClass("cw-app-active")&&!_locked()){var b=!1,c=A.my("data"),e=y,f=lib.mask(c,e.app.nodetitle)||e.app.title,g=e.app.maskstate?lib.tourl64(lib.mask(c,e.app.maskstate)):null,h="",i=[w.name,a.name,a.initstate,g&&g!==a.initstate?g:void 0].compact().join("/");document.title==f&&i===a.url||(a.app.updated=Date.now()),G||i===a.url||(a.app.url=a.url=i,a.app.state=g?g:null,h=window.location.href.split("#")[0]+"#"+i,window.history.replaceState(null,null,h),b=!0),document.title!=f&&(document.title=f,a.title=f,b=!0),b&&$.my.radio("slot.cw",{domid:y.domid,event:"crc"}),d()}}.debounce(CW.appToUrlTrackerDebounce)),A.on("commit",function(a){a.stopPropagation(),y.db.save().then(function(a){Object.merge(lib.getref(y.data,y.app.nodedoc),a,!0),A.my("redraw"),y.app.crccurr=y.app.crcdoc=lib.footprint(lib.getref(y.data,y.app.nodedoc))})}),A.on("cancel",function(a){a.stopPropagation(),y.app.close()}),c.resolve(a),c.promise()}function p(a){var b=_pi();if(t.cmd){"create"!==t.cmd&&w.markread(t.docid),y.app.crccurr=y.app.crcdoc="";try{y.app.crccurr=y.app.crcdoc=lib.footprint(lib.getref(y.data,y.app.nodedoc))}catch(a){}}return b.resolve(a),b.then(function(){$.my.radio("slot.cw",{domid:z,event:"start.slotready"})}),b.promise()}function q(a,e,f,g){var h,i,j,k={},l=e.name,m=!1,n=Object.select(e,["acl","actions","app","del","find","get","getAttachment","hide","inram","ishidden","isread","markread","put","ram","settings","sync","tags","users","uuid"]);h=k[l]={queue:[],revs:{},idxs:{},types:{"":_ee()}},Object.merge(n,{name:e.name,title:function(){return _dbsettings(l).title},info:function(a){return e.info(a||function(){})},query:function(b,c,d){return!isS(b)||/\//.test(b)?e.query(b,c,d):e.query(a.id.substr(3).replace(/\./g,"-")+"/"+b,c,d)},watch:function(a){if(null==a)return h.types;var b=isS(a)?a:"";return h.types[b]||(h.types[b]=_ee()),h.types[b]},form:function(a){return e.form(a)},load:function(){var b=!1,c=e.load.apply(a,arguments),d=function(){!b&&c.state&&"pending"==c.state()&&(b=!0,a.app.busy(!0))}.delay(60);return c.always(function(){b&&a.app.busy(!1),d.cancel()}),c},save:function(b,c){function d(a){return a.hasOwnProperty("CRYPTO")?(_decrypt(a,!0).then(function(a){h.resolve(a)}).fail(function(a){h.reject(a,lang.ERR_DECAFTERSAVE)}),void 0):h.resolve(a)}var f,g=!1,h=_pi(),i=m&&null==b,j=function(){!g&&h.state&&"pending"==h.state()&&(g=!0,a.app.busy(!0))}.delay(60);return i?(f=lib.getref(a.data,a.app.nodedoc),f.stamp=Date.now(),e.save.call(a,f,c).then(d).fail(function(a,b){h.reject(a,b)})):e.save.apply(a,arguments).then(d).fail(function(a,b){h.reject(a,b)}),h.then(function(b){!m||b._id!==lib.getref(a.data,a.app.nodedoc)._id&&"create"!=lib.getref(a.data,a.app.nodecmd)||(a.app.crccurr=a.app.crcdoc=lib.footprint(b))}),h.always(function(){g&&a.app.busy(!1),j.cancel()}),h.promise()},att:function(a){var b=_att(l,a);return b?(H[a]||(H[a]=0),H[a]+=1,Object.merge({free:function(){return H[a]-=1,H[a]<1&&(H[a]=0,b.free()),!0}},Object.reject(b,"free"))):null}}),j=_qnotify.fill(k).debounce(1),i=_qchanged.fill(void 0,k,function(){F&&j()}),e.watch("").progress(function(a){if(isA(a))for(var b=0;b<a.length;b++)i(a[b])}),f.progress(function(a){"active"==a&&j()});var o=a.app.maskstate;return m=isA(o)&&2===o.length&&o[0]===a.app.nodecmd&&o[1]===a.app.nodedoc+"._id",m&&(a.cmd=t.cmd,a.docid=t.docid),Object.merge(a.app,{domid:z,url:t.url,initurl:t.initurl,caller:d||"",state:t.state,born:Date.now(),updated:Date.now(),isActive:function(){return F},isEditor:function(){return m},busy:function(a){return null==a?c.slot[t.initurl].busy:(c.slot[t.initurl].busy=!!a,A.toggleClass("cw-app-busy",!!a),$.my.radio("slot.cw",{domid:z,event:"busy"}),void 0)},layout:cw.layout.fill(a,!1),trigger:function(a,b,c){A.trigger(a,b,c)},run:function(b){return cw.state.set(b,a.app.starturl)},watch:f?f:null,local:function(b,c){var d,b=a.id+"/"+b;return void 0===c?JSON.parse(ls.getItem(b)):null===c?(d=JSON.parse(ls.getItem(b)),ls.removeItem(b),d):(ls.setItem(b,JSON.stringify(c)),void 0)},modal:function(a){var b=_pi(),c=a;return isO(c)&&c.manifest?(c=Object.merge({},a,!0),isS(c.manifest)&&(c.manifest=dbs[t.db].form(c.manifest)),Object.merge(c.manifest,{params:{cache:function(a){return dbs[t.db].form(a)}}},!0),$.my.modal(c)):b.reject(null)},close:function(c,d){var e,f,g=_pi();return g.fail(function(a){_note(a)}),m&&!d&&"view"!=lib.getref(a.data,a.app.nodecmd)&&($.my.modal(!0),f=lib.getref(a.data,a.app.nodedoc),e=lib.footprint(f),e!=a.app.crcdoc)?($.my.modal({manifest:"cw.Sys.YesNoCancel",data:{text:'<span class="fi-alert mr5 fs90 red1" ></span> '+lang.MSG_UNSAVED,yes:'<span class="fi-save fs90 o80"></span> '+lang.BTN_UNSAVED_OK,no:'<span class="fi-prohibited fs90 o80"></span> '+lang.BTN_UNSAVED_NO,cancel:lang.BTN_CANCEL},esc:!0,width:500}).then(function(a){isO(a)?("yes"==a.cmd&&n.save(f).then(function(){b(t.initurl,c).then(function(a,b){g.resolve(a,b)}).fail(function(a,b){g.reject(a,b)})}).fail(function(){g.reject(lang.ERR_SAVE_FAIL.assign(f._id.escapeHTML()))}),"no"==a.cmd&&b(t.initurl,c).then(function(a,b){g.resolve(a,b)}).fail(function(a,b){g.reject(a,b)})):g.reject("Cancelled")}).fail(function(){g.reject(lang.TXT_CLOSECANCEL)}),g.promise()):b(t.initurl,c)},me:function(a){return cw.me(a)}}),a.db=n,a.attctr=H,a}function r(a,b){E||(cw.log("Appswitch failed",a,b),A&&A.remove(),B&&B.off(!0),D.reject(a,b)),E=!0}var s,t,u,v,w,x,y,z,A,B,C,D=_pi(),E=!1,F=!1,G=!1,H={};return _locked()?(r(0,lang.ERR_SYSLOCKED),D.promise()):isS(a)?(D.always(function(){_lock(!1)}),D.fail(function(a,b){_note(b,"error"),delete c.slot[t.initurl],$.my.radio("slot.cw",{domid:z,event:"start.fail"})}),D.then(function(a){window.location.hash=a.app.url}),_lock(!0),t=_parseURL(a),isO(t)?t.error?(r(1,t.reason||lang.ERR_SLOTPARAMS),D.promise()):Object.size(_acl(t.db,t.app))||Object.size(_acl(t.db,t.appid))||t.db+"/"+t.app==CW.appDefault?(s=t.url,cw.log("Appswitch: ",a,d),C=Object.values(c.slot).find(function(b){var c=b.initurl,d=b.url;return c==s||d==s||c==a||d==a||c==t.initurl||d==t.initurl}),C?(z=C.domid,v=c.slot[c.active].domid,v!=z&&c.status[v].notify("inactive"),c.status[z].notify("active"),s!=C.initurl&&s!=C.url&&C.$app.my("data",t.stateobj),D.resolve(C).promise()):(w=dbs[t.db],y=dbs[t.db].form(t.appid),x=_dbsettings(t.db),e().then(f).then(g).then(i).then(j).then(k).then(h).then(l).then(m).then(n).then(o).then(p).then(function(a){$(document).scrollTop(0),cw.log("Appswitch success"),D.resolve(a)}).fail(function(a,b){r(a,b)}),D.promise())):(r(1,lang.ERR_SLOTAPP_ACL),D.promise()):(r(1,lang.ERR_SLOTPARAMS),D.promise())):(r(1,lang.ERR_SLOTPARAMST),D.promise())}})}(state),function(a){var b={},c={},d={};_att=function(a,e){function f(a,b){var c=_pi();return g(a,b,function(a,b){c.resolve(a,b)}),c.promise()}function g(a,b,c){var d=i(a),f={},g=l._attachments,k=function(){(isF(c)?c:FN)(f)}.after(d.length);d.reduce(function(a,c){var d=Object.reject(g[c],"data");return j[c]&&j[c][0]===d.revpos?h(d,j[c][1],b,c).always(function(b){a[c]=b,k()}):m.getAttachment(e,c).then(function(e){h(d,e,b,c).always(function(b){a[c]=b,k()})},function(){k()}),a},f)}function h(a,b,c,d){var e=_pi();return j[d]&&j[d][0]===a.revpos||(j[d]=[a.revpos,b]),a.size=b.size,"blob"==c?(a.blob=b,e.resolve(a,a.blob)):"url"==c?(k[d]&&k[d][0]===a.revpos?a.url=k[d][1]:(k[d]&&URL.revokeObjectURL(k[d][1]),k[d]=[a.revpos,URL.createObjectURL(b)],a.url=k[d][1],a.blob=b),e.resolve(a,a.url)):"data"==c?lib.blob2base64(b,function(c){a.data=c,a.blob=b,e.resolve(a,c)}):"image"==c&&lib.blob2base64(b,function(c){a.image=c,a.blob=b,e.resolve(a,c)},!0),e.promise()}function i(a){var b,c=l._attachments;if(!isO(c))return[];if(null==a)return Object.keys(c);if(isS(a))b=[a];else if(isA(a))b=a;else if(isO(a))b=Object.keys(a);else if(isF(a))b=Object.keys(Object.findAll(c,a));else{if(!isR(a))return[];b=Object.keys(c).filter(a)}return b.findAll(function(a){return!!c[a]})}if(!ram[a]||!ram[a][e])return null;var j,k,l=ram[a][e],m=dbs[a];return b[a]||(b[a]={},c[a]={},d[a]={}),b[a][e]||(b[a][e]={},c[a][e]={},d[a][e]=0),j=b[a][e],k=c[a][e],d[a][e]++,{blob:f.fill(void 0,"blob"),url:f.fill(void 0,"url"),data:f.fill(void 0,"data"),image:f.fill(void 0,"image"),free:function(b){d[a][e]-=isNaN(b)?1:0|b,d[a][e]<0&&(d[a][e]=0),d[a][e]<1&&function(){d[a][e]<1&&_att.flush(a,e)}.delay(CW.gcAttsInterval)}}},Object.defineProperty(_att,"flush",{value:function(a,d){if(b[a]&&b[a][d]){var e,f=b[a][d],g=c[a][d];for(e in f)delete f[e];for(e in g)URL.revokeObjectURL(g[e][1]),delete g[e];return!0}return!1}})}(cw),_connect=function(id,postpone,autoCompact){function _startChanges(a){var b=a?a.update_seq||0:0;con(dbid+": last update sequence is "+b);var c={since:b,continuous:!0,live:!0,timeout:!1,heartbeat:1e4};_restart=_listen.fill(c).debounce(5e3),_listen(c)}function _listen(a){changes&&changes.cancel(),changes=db.changes(a),changes.on("change",_dbchanged).on("complete",_restart).on("error",_restart)}function _dbchanged(a){a.changes&&a.changes[0]&&a.changes[0].rev&&(!ram[dbid][a.id]||ram[dbid][a.id]._rev!=a.changes[0].rev)&&(con(dbid+": changes in "+a.id,a),"cw"==dbid&&/^db\-.*\-read$/.test(a.id)?(con("Readstate update"),sys.get(a.id).then(function(a){_cmpreads(a.db,a)})):a.deleted?_uncache(dbid,a.id):ext?ext.load([a.id]):"")}function _findRead(){!sys||!sys.load||read[dbid]&&Object.size(read[dbid].read)?(_extdb(db,dbid),_fin()):(con(dbid+": reading read and hidden list"),sys.load(["db-"+dbid+"-read"]).then(function(a){a.length&&(read[dbid]=a[0])},function(a,b){con(a,b)}).always(function(){_extdb(db,dbid),postpone?(setTimeout(_loadForms,postpone),_fin()):_loadForms().always(_fin)}))}function _loadForms(){return _dbsettings(dbid).dataOnly?_pi().resolve().promise():ext.load("cw-","cwz","manifest").then(function(a){a.length&&con("Read "+a.length+" manifest"+(a.length>1?"s":"")+" from DB "+dbid+".")})}function _fin(){_replicator(db,dbid),pi.resolve(dbs[dbid])}function _replicator(a,b){function c(a,f,i,j,k,o){function r(g){x||y||z||(p[e(f)]=!(!g&&!j)&&Date.now()+6e4*(g||j),x=!0,d(c.fill(a,f,i,j,A,null),g||j,f),void 0===g?(h("stop"),cw.event("db replication failed",b)):(h("finish"),cw.event("db replication finished and rescheduled",b)))}var s=!1,t=i.indexOf("to")!=-1,u=i.indexOf("from")!=-1,v=j?{batches_limit:1e4,batch_size:CW.batchSize||10}:{continuous:!0,live:!0,heartbeat:15e3,timeout:45e3,batches_limit:1e4,batch_size:CW.batchSize||10},w=j?{batches_limit:1e4,batch_size:CW.batchSize||10}:{continuous:!0,live:!0,heartbeat:15e3,timeout:45e3,batches_limit:1e4,batch_size:CW.batchSize||10},x=!1,y=!1,z=!1,A=$.extend({from:"",to:""},k||{});if("stop"==n)return con(b+": replication stopped, restart supressed"),!0;if(!navigator.onLine)return con(b+": replication postponed, browser is offline"),r(),!0;if(!q[f])if(/^http[s]?:\/\//.test(f))q[f]=Pouch(f,{ajax:{timeout:6e5,cache:!0}});else if("/"==(f+"")[0])q[f]=Pouch((cw.root||"").replace(/\/$/,"")+f,{ajax:{timeout:6e5,cache:!0}});else{if(!dbs[f])return con(b+": replication stopped, local bucket ‘"+f+"’ doesn’t exist"),!0;q[f]=dbs[f]}try{m[f]&&m[f].cancel(),u&&(w.since=0,Object.isNumber(o)?w.since=o:g("from",e(f))&&(w.since=g("from",e(f)).seq||0),w.since||!/^http[s]?:\/\//.test(f)||A.from||a.replicate.from(q[f],Object.merge({query_params:{filter:"_design"}},w)).then(function(){con(b+": initial sync-in of ddocs complete.")}).catch(function(a){con(b+": initial sync-in of ddocs failed.",a)}),A.from&&(isS(A.from)?w.filter=A.from:isA(A.from)&&(w.doc_ids=A.from.slice(0))),z=!0,m[f]=a.replicate.from(q[f],w),m[f].on("complete",function(a){z=!1,r(j),g("from",e(f),{seq:a.last_seq,stamp:Date.now()})}),m[f].on("error",function(a){z=!1,j?(r(j),con(b+": sync-in failed, next cycle scheduled.",a)):(y=!1,r(.5),con(b+": sync-in closed.",a))}),m[f].on("change",function(a){g("from",e(f),{seq:a.last_seq,stamp:Date.now()})}))}catch(a){console.log(a),s=!0,z=!1}try{l[f]&&l[f].cancel(),t&&!s&&(v.since=0,Object.isNumber(o)?v.since=o:g("to",e(f))&&(v.since=+(g("to",e(f)).seq||0)),A.to&&(isS(A.to)?v.filter=A.to:isA(A.to)&&(v.doc_ids=A.to.slice(0))),y=!0,l[f]=a.replicate.to(q[f],v),l[f].on("complete",function(a){y=!1,r(j),g("to",e(f),{seq:a.last_seq,stamp:Date.now()})}),l[f].on("error",function(a){y=!1,j?(r(j),con(b+": sync-out failed, next cycle scheduled.",a)):(y=!1,r(.5),con(b+": sync-out closed.",a))}))}catch(a){console.log(a),s=!0,y=!1}return p[e(f)]=!s,s?(h("stop"),cw.event("db replication start failed",b),con(b+": sync failed, restart required."),r()):(h("start"),cw.event("db replication started",b),con(b+": sync (re)started.")),s}function d(a,b,c){var d;i||"start"!==n||(d=a.delay(6e4*b||CW.syncRestart),d.url=f(c),o.add(d,0)),o.length>50&&o.splice(50)}function e(b){return a._key.from(3)+"-"+k([b])}function f(a){return"string"!=typeof a?"":a.split("@").last().replace(/^http[s]?:\/\//i,"")}function g(a,b,c){return c?(localStorage.setItem("_repl_"+a+"_"+b,cw.lib.json(c)),void 0):cw.lib.unjson(JSON.parse(localStorage.getItem("_repl_"+a+"_"+b)))}function h(a){$.my.radio("sync.cw",{db:b,event:a})}var i=!1,j=_dbsettings(b),k=cw.lib.crc2,l={},m={},n="stop",o=[],p={},q={};$.extend(ext,{sync:function(d,e){if(null==d)return p;var g,i,k=e?f(e):null;if(d===!0||0===d){for(n="warm",j=_dbsettings(b),g=0;g<j.sync.length;g++)i=j.sync[g].dir,!isA(i)||!i.length||e&&k!=f(j.sync[g].url)||(o=o.map(function(a){return e&&k!=a.url?a:(a.cancel(),null)}).compact(),c(a,_getSyncUrl(b,g),i.slice(0),1*j.sync[g].interval||0,j.sync[g].filter,0===d?0:null));n="start"}else if(d===!1&&!e){n="stop",con("Replication of "+b+" stopping...");for(g in m)m[g].cancel();for(g in l)l[g].cancel();for(g in p)p[g]=!1;cw.event("db replication stopped",b),h("stop")}return p}})}function _extdb(db,dbid){function _actions(a){var b=_acl(dbid);if((lib.getref(b,["*","*"])||[]).indexOf("*")>-1)return isS(a)?Object.clone((types[dbid]||{})[a]||{},!0):null==a?Object.clone(types[dbid]||{},!0):{};var c={};Object.keys(b).forEach(function(a){Object.keys(b[a]).forEach(function(d){c[d]||(c[d]={}),b[a][d].forEach(function(b){c[d][b]||(c[d][b]={}),c[d][b][a]=!0})})});var d=types[dbid]||{},e={},f=lib.getref(b,["*","*"])||[];return Object.keys(d).forEach(function(a){(c[a]||f.length)&&(c[a]?(e[a]={},Object.keys(d[a]).forEach(function(b){var g;if(c[a][b]?g=c[a][b]:(f.indexOf("*")>-1||f.indexOf(b)>-1)&&(g=cw.lib.a2o(d[a][b])),g&&Object.size(g)){var h=d[a][b].filter(a=>g["cw."+a]||g[a]||g[a.replace(/^[a-z][^.]+\./,"")]);h.length&&(e[a][b]||(e[a][b]=[]),e[a][b]=e[a][b].union(h))}}),Object.size(e[a])||delete e[a]):e[a]=b["*"])}),Object.clone(null!=a?e[a]||{}:e,!0)}function _dbapp(a){var b,c;return null==a?(c=_acl(dbid),b="cw"===dbid?Object.keys(dbapps[dbid]).sort():Object.keys(dbapps.cw).union(Object.keys(dbapps[dbid])).sort(),b=b.filter(a=>c[a]||c["*"])):(b="cw"===dbid?Object.clone(dbapps[dbid][a],!0):Object.clone(dbapps[dbid][a]||dbapps.cw[a],!0),Object.size(_acl(dbid,a))||Object.size(_acl(dbid,"*"))||(b=null)),b}function _dbram(a){var b,c=[];if(isS(a)&&rd[a])c.push(rd[a]);else if(isA(a))for(b=0;b<a.length;b++)rd.hasOwnProperty(a[b])&&c.push(rd[a[b]]);else if(isF(a))try{for(b in rd)a(rd[b])&&c.push(rd[b])}catch(a){}return c}function _dbwatch(a){var b=isS(a)?a:"";return watchers[dbid].types[b]||(watchers[dbid].types[b]=_ee()),watchers[dbid].types[b]}function _dbmarkhidden(a){var b=ram[dbid][a],c={};return"cw"==dbid?null:(b&&!b._hidden?(c=$.extend(c,b),c._hidden=!0,_cache(c)):(read[dbid].hidden[a]=!0,read[dbid]._dirty=(read[dbid]._dirty||0)+1),read[dbid].hidden[a]||null)}function _dbmarkread(a){var b=ram[dbid][a],c={};return"cw"==dbid?null:b&&b._rev!==b._read?(c=$.extend(c,b),c._read=c._rev,_cache(c)):b}function _isread(a){return"cw"==dbid?null:read[dbid].read[a]||null}function _ishidden(a){return"cw"==dbid?null:read[dbid].hidden[a]||null}function _dbdeldoc(a){function b(b){db.remove(b).then(function(a){d.resolve(a)}).catch(function(c){con(c),d.reject(lang.ERR_DOCDELFAIL.assign(((b.title||b.name||a)+"").escapeHTML()))})}var c=ram[dbid][a],d=_pi();return"cw"===dbid&&"cw"==a?d.reject(lang.ERR_NODELSETTINGS):c&&!c._hidden?b(c):db.get(a).then(function(a){b(a)}).catch(function(b){con(b),d.reject(lang.ERR_DOCNOEXIST.assign((a+"").escapeHTML()))}),d.promise()}function _dbfind(A1,A2,A3){var pi=_pi(),params={},sort=null,reverse=!1,rnd,fn,filter=A1,start,end,str;return isO(A2)&&(isF(A1)||isS(A1))&&(void 0!==A2.start&&void 0!==A2.end&&(start=A2.start,end=A2.end,reverse=!1,start>end&&(start=A2.end,end=A2.start,reverse=!0),params.startkey=start,params.endkey=end),isF(A2.sort)&&(sort=A2.sort)),isO(A1)&&A1.filter&&(filter=A1.filter,void 0!==A1.start&&void 0!==A1.end&&(start=A1.start,end=A1.end,reverse=!1,start>end&&(start=A1.end,end=A1.start,reverse=!0),params.startkey=start,params.endkey=end),isF(A1.sort)&&(sort=A1.sort)),isS(filter)&&(str=filter,filter=function(a){return a.type===str?a._id:null}),isF(filter)?(rnd="cwfind_"+Date.now()+"_"+Number.random(1e6),window[rnd]=filter,fn=eval('(function(d){var k=window["'+rnd+'"](d);if(undefined!==k&&null!==k&&false!==k)emit(k!==true?k:d._id,d);})'),null===sort&&(isF(A2)||isS(A2))&&(sort=A2,reverse=!!A3),db.query(fn,params).then(function(a){delete window[rnd];var b,c=[],d=0;if(a.rows.length){for(;d<a.rows.length;d++)a.rows[d].value._db=dbid,b=_cache(a.rows[d].value),n(b)&&c.push(b);pi.resolve(null!==sort?c.sortBy(sort,reverse):c)}else pi.resolve([])},function(a){delete window[rnd],pi.reject(a,"Error searching docs.")})):pi.reject({status:999,message:"No filter function provided."},"No filter function provided."),pi.promise()}var i,rd=ram[dbid],title="",dbset=_dbsettings(dbid);return ext={_local:db._local,_key:db._key,name:dbid,title:function(){return _dbsettings(dbid).title},settings:_dbsettings.fill(dbid),acl:_acl.fill(dbid),actions:_actions,form:cw.form.fill(void 0,dbid),app:_dbapp,att:function(a){return _att(dbid,a)},save:_dbsave,load:_dbload,ram:_dbram,inram:function(a){return rd.hasOwnProperty(a)},tags:function(){return Object.keys(tags[dbid]).sort()},find:_dbfind,watch:_dbwatch,markread:_dbmarkread,isread:_isread,hide:_dbmarkhidden,ishidden:_ishidden,uuid:function(a){return cw.uuid(a)},users:function(a){return users[dbid]},del:_dbdeldoc,replicate:{to:db.replicate.to.bind(db),from:db.replicate.from.bind(db)}},["post","put","putAttachment","removeAttachment","remove","compactDocument","compact"].forEach(function(a){if(!ext[a]&&isF(db[a])){var b=db[a];ext[a]=function(){var a=[],c=0,d=_pi();if(_dbsettings(dbid,"readOnly")&&(!isO(arguments[0])||!/^_local\/.+/.test(arguments[0]._id+"")))return d.reject({error:!0,message:"Bucket is read-only",name:"forbidden",reason:"db non writable",status:403}),d.promise();for(;c<arguments.length;c++)a.push(arguments[c]);return b.apply(db,a).then(function(a,b,c){d.resolve(a,b,c)},function(a,b,c){d.reject(a,b,c)}),d.promise()}}}),["query","viewCleanup","revsDiff","bulkGet","get","getAttachment","allDocs","info","id"].forEach(function(a){
if(!ext[a]&&isF(db[a])){var b=db[a];ext[a]=function(){for(var a=[],c=0,d=_pi();c<arguments.length;c++)a.push(arguments[c]);return b.apply(db,a).then(function(a,b,c){d.resolve(a,b,c)},function(a,b,c){d.reject(a,b,c)}),d.promise()}}}),["bulkDocs","type","changes","on","once","emit","addListener","setMaxListeners","removeListener","removeAllListeners","listeners","listenerCount"].forEach(function(a){!ext[a]&&isF(db[a])&&(ext[a]=db[a].bind(db))}),dbs[dbid]=ext}function _dbsave(a,b){function c(a){return _dbsettings(dbid,"readOnly")?(i.reject({error:!0,message:"Bucket is read-only",reason:"forbidden",status:403},lang.ERR_SAVE_READONLYDB.assign(d._id.escapeHTML())),void 0):(db.put(a).then(function(a){db.get(a.id).then(function(a){a._read=a._rev,a._db=dbid,a=_cache(a),i.resolve(a),b||_note((a.type||"Doc").capitalize()+" "+(a.name||d._id)+" saved.","ok")},function(a){i.reject(a,"Error reading doc "+d._id+" after save.")})}).catch(function(e){"409"!=e.status||b?(con("Error saving "+d._id+" into "+ext.name,e.status,e.message),i.reject(e,lang.ERR_SAVE_DBFAIL.assign(d._id.escapeHTML()))):$.my.modal({manifest:"cw.Sys.Confirm",data:{text:'<span class="fi-alert o70 mr5 fs90"></span> '+lang.MSG_CONFLICT,ok:lang.BTN_CONFLICT,cancel:lang.BTN_CANCEL}}).then(function(b){isO(b)&&"commit"===b.cmd?db.allDocs({startkey:d._id,endkey:d._id}).then(function(b){var d=b.rows;d&&d.length?(a._rev=d[0].value.rev,c(a)):(delete a._rev,c(a))},function(a){i.reject(a,lang.ERR_OWR_READ.assign(d._id.escapeHTML()))}):(con("Save of "+d._id+" into "+ext.name+" was cancelled, conflict"),i.reject(e,lang.MSG_CONFLICT_CANCEL.assign(d._id.escapeHTML())))}).fail(function(){con("Save of "+d._id+" into "+ext.name+" was aborted, conflict"),i.reject(e,lang.MSG_CONFLICT_CANCEL.assign(d._id.escapeHTML()))})}),void 0)}cw.debug&&b&&console.log("Silent save request",a);var d,e,f,g,h,i=_pi();if(i.fail(function(a,c){b||_note(c,"error")}),isO(a))if(a.CRYPTO)i.reject({error:!0,message:"Saving pre-encrypted docs is forbidden",reason:"forbidden",status:403},lang.ERR_SAVE_PRENC);else if(a.name&&a.type)if("cw"==a._id&&"cw"==dbid)i.reject({},"Saving system settings is forbidden using .save() method.");else{if(d=Object.clone(Object.reject(a,"_attachments"),!0),e=isA(d.log),f=!d._id||!d._rev,a._attachments&&Object.size(a._attachments)){d._attachments={};for(var j in a._attachments)g=a._attachments[j],g.data?(d._attachments[j]=Object.select(g,["data","content_type"]),d._attachments[j].length=3*(g.data.length/4|0)):d._attachments[j]=Object.select(g,["content_type","digest","revpos","stub","length"])}f?(d.stamp=Date.now(),d._id=d._id||cw.uuid(me.name),delete d._rev,e&&(d.log=[[Date.now(),"create",me.name+"-"+me.uid,1,dbid]]),d.creator=d.creator||me.name+"-"+me.uid):e&&(h=me.name+"-"+me.uid,(!d.log.length||d.log[0][2]!=h||Date.now()-d.log[0][0]>6e5)&&d.log.add([[Date.now(),"update",h,1*d._rev.split("-")[0]+1,dbid]],0),d.log.length>50&&(d.log=d.log.to(49).add([d.log.last()]))),_encrypt(d,!0).then(function(a){c(a)}).fail(function(a){console.log(a),i.reject({status:999,message:a+""},lang.ERR_SAVE_ENCRYPT.assign(d._id.escapeHTML()))})}else i.reject({error:!0,message:"Invalid .name or .type fields",reason:"forbidden",status:403},lang.ERR_SAVE_NAMETYPE);else i.reject({error:!0,message:"No doc to save",reason:"bad_request",status:400},lang.ERR_SAVE_NODOC);return i.promise()}function _dbload(a,b,c){var d,e=_pi(),f=[],g=ram[dbid];if(isA(a))a.length||e.resolve([]),f=a.map(function(a){var b=a+"";if(n(a)&&b.length>0)return b}).compact(),d=isS(b)?b:null,db.allDocs({keys:f,include_docs:!0,conflicts:!0}).then(function(a){var b,c=[],f=0;if(!a.rows.length)return e.resolve([]);for(;f<a.rows.length;f++)!a.rows[f].doc||d&&a.rows[f].doc.type!=d||(a.rows[f].doc._db=dbid,b=_cache(a.rows[f].doc),n(b)&&c.push(b));e.resolve(c)}).catch(function(a){e.reject(a,"Error reading docs by keylist.")});else if(isS(a)&&(void 0===b||isB(b)))g.hasOwnProperty(a)&&g[a]._full?g[a]._deleted||g[a]._hidden?e.resolve(null):e.resolve(g[a]):db.get(a,{attachments:b,conflicts:!0}).then(function(a){var c=a;c._db=dbid,c._full=!!b,c=_cache(c),e.resolve(c)}).catch(function(){e.resolve(null)});else if(isS(a)&&isS(b)){var h=a,i=b,j=!1;a>b&&(h=b,i=a,j=!0),d=isS(c)?c:null,db.allDocs({startkey:h,endkey:i,descending:j,include_docs:!0,conflicts:!0}).then(function(a){var b,c=[],f=0;if(!a.rows.length)return e.resolve([]);for(;f<a.rows.length;f++)(!d||a.rows[f].doc&&a.rows[f].doc.type==d)&&(a.rows[f].doc._db=dbid,b=_cache(a.rows[f].doc),n(b)&&c.push(b));e.resolve(c)}).catch(function(a){e.reject(a,"Error reading docs by keylist.")})}return e.promise()}var ext,db,dbid=id+"",pi=_pi(),changes,_restart;if(dbs[dbid])return pi.resolve(dbs[dbid]).promise();try{db=new Pouch(dbid,Object.merge({},autoCompact?{auto_compaction:!0}:{}))}catch(a){return pi.reject(a,"Connection to DB "+dbid+" failed.").promise()}return con(dbid+": DB connected"),watchers[dbid]=watchers[dbid]||{queue:[],revs:{},idxs:{},types:{"":_ee()}},users[dbid]=users[dbid]||{},forms[dbid]=forms[dbid]||{_src:{},_name:"DB "+dbid+" manifest cache"},types[dbid]=types[dbid]||Object.clone(types.cw,!0),ram[dbid]=ram[dbid]||Object.extended(),read[dbid]=read[dbid]||_ReadHideListDoc(dbid),dbapps[dbid]=dbapps[dbid]||{},appfiles[dbid]=appfiles[dbid]||{},tags[dbid]=tags[dbid]||{},Q(db.info()).then(_startChanges).then(_findRead).fail(function(a){var b=isS(a)?a:isO(a)?lang.ERR_DBNOCONN:a+"";pi.reject(a,lang.ERR_CONNFAIL.assign(dbid,b))}),pi.promise()},$.my.ajax(_ajax),cw.me=function(a){if(void 0===a)return me.name;if(null===a)return Object.clone(me,!0);if("locale"==a)return(me.locale||window.navigator.language||"en").split("-")[0];var b=me[a],c=typeof b;return"object"==c?Object.clone(b,!0):b}.fill(),cw.dbs=function(){var a={},b=Object.keys(dbs);return b.forEach(function(b){var c=dbs[b].title();c&&(a[b]=c)}),a},cw.version=function(){return VERSION},cw.version.toString=function(){return VERSION},cw.config=function(a){if(a&&!/^\$/.test(a+"")){var b=CW[a],c=$.type(b);if(null==b)return b;if(/object|array/.test(c))return Object.clone(b,!0);if("function"!=c)return b}}.fill(),Object.merge(cw,{CW:CW,acl:_acl.fill(),locked:_locked,lock:_lock,state:Object.clone(state),db:function(a){return dbs[a]?Object.merge({},dbs[a]):null},con:function(){con.apply(null,arguments)},ram:function(a,b){return ram[a]&&ram[a][b]?Object.clone(ram[a][b],!0):null},dbsettings:function(a,b){return _getDbSettings(a,b)},note:_note,read:read,reg:_register,start:_startCloudwall})}(cw,window),function(a){function b(a){var b=a.app?a.app:a,d=(b.padding||"")+""||"auto",g=[],h=0,i=0,j="0px",k=c.maxSpaceWidth||c.defaultSpaceWidth;if("none"==d&&(k+=c.margins),g=e(b.width)&&b.width.length?b.width:g,g=g.map(function(a){return f(a)||e(a)&&2==a.length?a:parseInt(a+"")}).compact(!0),g.length||g.push(k),g.forEach(function(a){f(a)&&h<a&&a<=k?h=a:e(a)&&h<a[1]&&a[0]<=k&&(h=Math.min(a[1],k))}),0===h&&(h=(g+"").split(",").map(Number).min()),i=h,"auto"==d){i=(i+c.margins).clamp(0,k+c.margins);var l=c.margins/2+"px";j=[l,l,0,l].join(" ")}else/\dpx/.test(d)&&(j=d);return{slot:h,space:i,pads:j,left:0,right:0}}var c=a.CW,d=Object.isObject,e=Object.isArray,f=Object.isNumber;a.buildDOM=function(){var b,d;for(b in c)if("$"===b.to(1))if("$body"==b&&$(c[b]).length)c[b]=d=$(c[b]);else{if(!$(c[b]).length)throw"Unsuitable DOM structure, "+b+" mount point does not exist";c[b]=$(c[b])}return c.$upic.attr("src",a.me("pic")),c.$slots.css({width:c.defaultSpaceWidth+"px"}),c.$space.css({width:c.defaultSpaceWidth+"px",transition:"width 0.08s",display:"block"}),$(window).on("resize",function(){c.maxSpaceWidth=$(window).width()-c.margins,a.layout()}.debounce(67)),a.event().progress(function(a){/^slot/i.test(a)&&$.my.radio("slot.cw",{domid:"",event:"statechange"})}.debounce(2)),a.con("End dom prepare"),d},a.layout=function(e,f){var g=d(e)&&e.app?e:a.state.get();if(f===!1)return b(g.app);var h=d(f)?f:b(g.app);return Object.merge(g.width,h),c.$body.width(h.space),c.$space.css({width:h.space+"px",padding:h.pads}),c.$slots.width(h.slot),g.$app.width(h.slot),g.notify("layout"),f}}(window.cw),function(a){const b={en:{NOSTRING:"Not valid URL hash string",SHORTLONG:"Too many slashes in the path",NODB:"Bucket {1} does not exist or unreacheable",NOAPP:"The {1} app is unrecognized for {2} bucket",NOSTATE:"Can’t decode app state",ERRSTATE:"Invalid app state",NOCMD:"Editor {1} does not support command {2}",ERRNEW:"Can’t create new doc for {1} editor",ERRID:"No doc _id for editor {1} to open",NOMSTATE:"Can’t build app {1} start state object"},ru:{NOSTRING:"Неверный формат URL хэша",SHORTLONG:"Слишком много слэшей в пути",NODB:"БД {1} не существует или недоступна",NOAPP:"Приложение {1} не найдено для БД {2}",NOSTATE:"Невозможно расшифровать парметры старта приложения",ERRSTATE:"Неверные параметры старта приложения",NOCMD:"Редактор {1} не поддерживает команду «{2}»",ERRNEW:"Ошибка при создании нового документа для редактора {1}",ERRID:"Не указан _id документа для открытия редактором {1}",NOMSTATE:"Ошибка при построении параметров запуска приложения {1}"}};a.parseURL=function(c){function d(a,c,d){return j.reason=((b[e]||b.en)[a]||b.en[a]||"Unknown error "+a).assign(c,d),j}const e=a.me("locale")||"en",f=Object.isArray,g=Object.isString,h=Object.isObject,i=a.lib;a.con;var j={status:400,error:"bad_request",reason:""};if(!c||!g(c))return d("NOSTRING");var k,l,m,n,o,p={src:"",url:"",initurl:"",db:"",dbtitle:"",app:"",apptitle:"",appid:"",state:"",initstate:"",stateobj:{},cmd:"",cmdtypes:[],docid:"",doctype:""},q=[],r="",s="";Object.keys(a.dbs());if(r=/#/.test(c)?c.split("#")[1]||"":c+"",r=r.replace(/\/+$/,""),q=r.split("/").compact(!0),q.length<2||q.length>4)return d("SHORTLONG");if(!(k=a.db(q[0])))return d("NODB",q[0]);if(p.db=k.name,p.dbtitle=k.title(),!(l=a.form(q[1],k.name)))return d("NOAPP",q[1],q[0]);if(p.appid=l.id,p.app=l.app.name,p.apptitle=l.app.title,m=l.app,null==q[2]&&(q[2]=""),null==(n=i.fromurl64(q[2])))return d("NOSTATE");if($.type(n)!==$.type(m.maskstate)){if(""!==n)return d("ERRSTATE");n=i.mask(l.data,m.maskstate)}else n=i.unmask(n,m.maskstate);if(null==n&&d("ERRSTATE"),f(m.maskstate)&&2===m.maskstate.length&&m.maskstate[0]===m.nodecmd&&m.maskstate[1]===m.nodedoc+"._id"){if(p.cmd=a.lib.mask(n,m.maskstate[0])||"create",p.docid=a.lib.mask(n,m.maskstate[1])||"",g(p.cmd)&&h(m.types)&&Object.keys(m.types).length){for(var t in m.types)f(m.types[t])&&m.types[t].indexOf(p.cmd)!=-1&&p.cmdtypes.push(t);p.cmdtypes.length||d("NOCMD",p.app,p.cmd)}if("create"==p.cmd){var u,v,w=p.docid,x=a.uuid();if(w?h(m.types)&&m.types[w]?u=w:v=w:h(m.types)&&1===p.cmdtypes.length&&(u=p.cmdtypes[0]),!u&&!v)return d("ERRNEW",p.app);$.extend(!0,n,i.unmask(x||v,m.nodedoc+"._id")),p.doctype=u||"",p.oldid=v||"",p.docid=x}else if(!p.docid)return d("ERRID",p.app)}return p.initstate=i.tourl64(i.mask(n,m.maskstate)),q[3]?null!==(o=i.fromurl64(q[3]))&&$.type(o)==$.type(m.maskstate)&&(o=i.unmask(o,m.maskstate),h(o)&&$.extend(!0,n,o)):(o=n,p.state=p.initstate),null==o?d("NOMSTATE",p.app):(p.state=i.tourl64(i.mask(n,m.maskstate)),p.stateobj=Object.clone(n,!0),s=[p.db,p.app,p.initstate].join("/"),p.initurl=s,p.initstate!==p.state&&(s+="/"+p.state),p.url=s,p.src=r,p)}}(cw),function(){var a={en:{},ru:{}};cw.localizePlugins=function(b){a[b]&&Object.keys(a[b]).forEach(function(c){try{a[b][c]()}catch(a){}})},a.ru.datepicker=function(){$.datepicker&&($.datepicker.regional.RU=$.datepicker.regional.ru={closeText:"Закрыть",prevText:"&#x3c;Пред",nextText:"След&#x3e;",currentText:"Сегодня",monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],monthNamesShort:["янв","фев","мар","апр","май","июн","июл","авг","сен","окт","ноя","дек"],dayNames:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"],dayNamesShort:["вск","пнд","втр","срд","чтв","птн","сбт"],dayNamesMin:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"],weekHeader:"Нед",firstDay:1,isRTL:!1,showMonthAfterYear:!1,yearSuffix:"",dateFormat:"dd.mm.yy"},$.datepicker.setDefaults($.datepicker.regional.ru))},a.ru.select2=function(){$.fn.select2&&$.extend($.fn.select2.defaults,{formatNoMatches:function(){return"Ничего не нашлось"},formatInputTooShort:function(a,b){var c=b-a.length;return"Ещё "+c+" знак"},formatSelectionTooBig:function(a){var b=(+a).pad(3).last(2);return"Не более "+a+" значени"+("11"!=b&&"1"==b.last(1)?"я":"й")},formatLoadMore:function(a){return"Загрузка…"},formatSearching:function(){return"Поиск…"}})},a.ru.redactor=function(){if($.fn.redactor)try{window.RLANG={html:"Код",video:"Видео",image:"Изображение",table:"Таблица",link:"Ссылка",link_insert:"Вставить ссылку...",link_edit:"Изменить ссылку",unlink:"Удалить ссылку",formatting:"Форматирование",paragraph:"Обычный текст",quote:"Цитата",code:"Код",header1:"Заголовок 1",header2:"Заголовок 2",header3:"Заголовок 3",header4:"Заголовок 4",bold:"Полужирный",italic:"Наклонный",fontcolor:"Цвет текста",backcolor:"Заливка текста",unorderedlist:"Обычный список",orderedlist:"Нумерованный список",outdent:"Уменьшить отступ",indent:"Увеличить отступ",cancel:"Отменить",insert:"Вставить",save:"Ok",_delete:"Удалить",insert_table:"Вставить таблицу",insert_row_above:"Добавить строку сверху",insert_row_below:"Добавить строку снизу",insert_column_left:"Добавить столбец слева",insert_column_right:"Добавить столбец справа",delete_column:"Удалить столбец",delete_row:"Удалить строку",delete_table:"Удалить таблицу",rows:"Строки",columns:"Столбцы",add_head:"Добавить заголовок",delete_head:"Удалить заголовок",title:"Подсказка",image_position:"Обтекание текстом",none:"Нет",left:"Cлева",right:"Cправа",image_web_link:"Cсылка на изображение",text:"Текст",mailto:"e-mail",web:"URL",video_html_code:"Код видеоролика",file:"Файл",upload:"Загрузить",download:"Скачать",choose:"Выбрать",or_choose:"Или выберите",drop_file_here:"Перетащите файл сюда",align_left:"По левому краю",align_center:"По центру",align_right:"По правому краю",align_justify:"Выровнять текст по ширине",horizontalrule:"Горизонтальная линейка",fullscreen:"Во весь экран",deleted:"Зачеркнутый",anchor:"Якорь",link_new_tab:"Открывать в новой вкладке",underline:"Подчеркнутый",alignment:"Выравнивание",filename:"Название (необязательно)"}}catch(a){}}}();