/*CloudWall 2.2.2 crypto lib and settings sandbox,  (c) ermouth*/
"cw"in window||(window.cw={}),cw.log||function(){var a=function(){function b(a){var b=0,c=[],d="";for(b;b<a.length;b++)d=JSON.stringify(a[b]),"string"==typeof d&&(p>=d.length?c.push(d):c.push(JSON.stringify("Truncated "+$.type(a[b])+": "+(g(a[b])?a[b]:d).truncate(p-1,"middle","…"))));return"["+c.join(",")+"]"}function c(a){var b="",c=k.getItem(l)||"";c.length+a.length>n?(b=k.getItem(m)||"",b.length>0&&(b+="\n"),b+=c,b.length>o?(b=b.last(o-1),b=b.from(1+b.indexOf("\n")),k.setItem(m,b)):k.setItem(m,b),k.setItem(l,a),b="",c=""):(k.setItem(l,(c.length?c+"\n":"")+a),c="")}function d(b){var c,d,e;for(d=0;d<b.length;d++)if(c=b[d],null!==c&&void 0!==c&&!i(c)&&!g(c)&&!Object.isDate(c))if(h(c)||f(c))try{c=JSON.stringify(c)}catch(a){c="Parsing "+$.type(c)+" of keys:["+Object.keys(c).join(", ")+"] failed: "+a.message,b[d]=c}else j(c)?b[d]="function "+c.name+"(){"+a.length+"}":"object"==typeof c&&g(c.jquery)&&j(c.each)?c.size()?(e=[],c.each(function(){var a=this,b=a.id,c=Array.prototype.slice.call(a.classList,0);e.push(a.nodeName+(b?"#"+b:"")+(c.length?"."+c.join("."):""))}),b[d]={jQuery:e}):b[d]={jQuery:[]}:b[d]=null}function e(){return q}var f=Object.isArray,g=(Object.isBoolean,Object.isString),h=Object.isObject,i=Object.isNumber,j=(Object.isRegExp,Object.isFunction),k=localStorage,l="_cw_log_curr",m="_cw_log_prev",n=5e4,o=1e6,p=500,q=j(cw.session)?cw.session():h(cw.lib)&&j(cw.lib.hash4)?cw.lib.hash4(Date.now()+" "+Number.random(1e5,1e6)):Number.random(65536,1048575).toString(16).last(4),r=Date.now()-2e4,s=Date.now();j(cw.session)||(cw.session=e),cw.log=function(a){var e,f=[],g=arguments.length,h=Date.now();if(null!=a||1!=g)return!g||1===g&&i(a)?i(a)?(e=a.clamp(1,1e6),f=(k.getItem(l)||"").split("\n"),f.length<e&&(f=(k.getItem(m)||"").split("\n").concat(f)),f=f.compact(!0).last(e),f):(k.getItem(l)||"").split("\n").compact(!0):(f=Array.prototype.slice.call(arguments,0),d(f),f.unshift(q),h-r<2e3?(f.unshift("+"+(h-s)),s=h):(f.unshift(h),r=s=h),c(b(f)),f=[],void 0)}.fill()};try{a()}catch(a){}Object.isFunction(cw.log)||(cw.log=console.log.bind(console))}(),cw.crypto||(cw.crypto=function(){function a(){return $.Deferred()}function b(a){return cw.lib.md5(cw.lib.md5(a)+cw.lib.hash8(a))}function c(a,c){return cw.lib.md5(b(a)+c)}var d,e,f,g,h=window.PouchDB,i=Object.isArray,j=(Object.isBoolean,Object.isString),k=Object.isObject,l=(Object.isNumber,Object.isRegExp,Object.isFunction),m={},n={},o={},p="type crypto stamp creator name pic tags _id _rev _attachments".split(" "),q=(p.slice(0).add("_attachments"),"CRYPTO"),r={},s=function(a){if(!a||!Object.isObject(a))return a;var b,c;return a.crypto&&(b=v(a.crypto),b=b?b.key:null),b||"cw"!==a._id||"settings"!==a.type||(b=a.pin,b&&!f&&(f=b)),b?(c=Object.select(a,p),c.CRYPTO=cw.lib.encDoc(Object.reject(a,p),b),c):a},t=function(a,b){if(!Object.isObject(a))return a;var c,d,e;if(a.hasOwnProperty(q)&&(a.crypto&&(c=v(a.crypto),c=c?c.key:null),c||"cw"!==a._id||(c=b)),c){try{d=cw.lib.decDoc(a.CRYPTO,c),e=Object.reject(Object.merge(Object.clone(a,!0),d),q)}catch(b){return a}return e}return a},u=function(a,b){if(!a||!b)return a;var c;if((c=v(b))&&(c=c.key)){var d=cw.lib.blob2base64(a),e=cw.lib.base64(btoa(cw.lib.dec(d,c).from(1)),!0);return cw.lib.base642blob(e)}return a},v=function(a){if(r[a])return r[a];r={};for(var b=e?e.keys:[],c=0;c<b.length;c++)r[b[c].id]=b[c];return r[a]||r},w=function(a){return v(),r.hasOwnProperty(a)},x=function(){var a,b=v(),c=[];return Object.keys(b).forEach(function(d){(a=b[d])&&a.name&&c.push({id:d,name:a.name+", "+a.emitter.split("-")[0]})}),c},y=function(){return Object.merge({},o||{})},z=function(){return Object.keys(n)},A=function(b,c,d){function f(a){var b=cw.lib.dry(e);if(cw.lib.md5(b)===v)return t.resolve("Nothing changed – no need to save");var c=new h("cw",function(a,d){a?t.reject("Error connectiong DB during settings save"):c.get("cw",function(a,d){a?t.reject("Error reading previous settings during settings save"):c.put(Object.merge(s(Object.merge(b,{crypto:"PIN",pin:g||b.pin})),{_rev:d._rev,stamp:Date.now()}),function(a,b){a?t.reject("Error saving settings"):t.resolve.debounce(1)("Settings saved sucessfully")})})})}if(j(b)&&null==c)return Object.merge({},n[b]||{},!0);if(null==b)return Object.merge({},n,!0);if(k(c)){var o,p,q,r=Object.clone(c,!0),t=a(),u=Object.clone(e,!0),v=cw.lib.md5(cw.lib.dry(e)),w=/^(http[s]?\:\/\/)[^\:@\/]+:[^@]+@(.+)(\/?)$/,x="apps ico pic name title desc stamp start sync creator".split(" ").sort(),y={},z=[];if(e.type="settings",t.always(function(){e=u,m={};for(var a=0;a<e.dbs.length;a++)m[e.dbs[a].name]=e.dbs[a]}),"delete"===r._cmd)$.my.modal({manifest:"cw.Sys.Confirm",data:{text:'<div class="red"><span class="fi-alert mr5 fs90"></span> DB removal requested. Please close all other tabs and browsers with CloudWall opened. Removing DB on this machine does not remove it on linked machines’ accounts. When DB purge finishes, tab reloads.</div>',ok:"Remove DB"}}).then(function(a){function b(a){return a.replace(/^(http[s]?\:\/\/[^\:@\/]+:)[^@]+(@.+)$/,"$1•••••$2")}var c=[];if(k(a)&&"commit"==a.cmd){for(var d=0;d<e.dbs.length;d++)e.dbs[d].name!==r.name?c.push(e.dbs[d]):A=Object.clone(e.dbs[d],!0);e.dbs=c,cw.db(r.name).sync(!1),t.then(function(){if(Object.isArray(A.sync))for(var a=0;a<A.sync.length;a++)A.sync[a].dir.forEach(function(c){localStorage.removeItem(["","repl",c,b(A.sync[a].url)].join("_"))});h.destroy(r.name).then(function(){cw.log("DB ‘"+r.name+"’ destroyed, reload scheduled."),window.location.reload()})}.debounce(500)),cw.log("Local DB ‘"+r.name+"’ deletion confirmed, saving updated settings."),f(e)}}).fail(function(){t.reject("DB deletion cancelled.")});else if("sync"===r._cmd||"sync0"===r._cmd)$.my.modal({manifest:"cw.Sys.Confirm",data:{text:'<div class=""><span class="fi-clock mr5 fs90 green"></span> DB forced sync requested. It can take some time, but you can continue working during process.  When replication finish you’ll see notification.</div>',ok:"Force replication"}}).then(function(a){var b=m[r.name];if(k(a)&&"commit"==a.cmd){for(var c=0;c<b.sync.length;c++)b.sync[c].dir.length&&!function(a,b){function c(c){cw.log("Forced sync ‘"+r.name+"’ "+a.dir[g]+" "+a.url+" finished",c),cw.note("Replication "+a.dir[g]+" "+b.url+" finished.","ok")}function e(c){cw.log("Forced sync ‘"+r.name+"’ "+a.dir[g]+" "+a.url+" failed",c),cw.note("Replication "+a.dir[g]+" "+b.url+" failed.","error"),console.log(c)}function f(a,b){if(l(d))try{d(a,b)}catch(a){}cw.db(r.name).sync(!0)}cw.log("Started forced sync ‘"+r.name+"’ "+a.dir.join("&")+" "+a.url);var g=0;cw.db(r.name).sync(!1);var h="sync0"===r._cmd?{since:0}:{};cw.db(r.name).replicate[a.dir[g]](a.url,h,function(b,d){b?e(b):c(d),g+=1,a.dir[g]?cw.db(r.name).replicate[a.dir[g]](a.url,h,function(a,b){a?e(a):c(b),f(a,b)}):f(b,d)})}(b.sync[c],r.sync[c]);t.resolve("Started forced DB sync.")}}).fail(function(){t.reject("DB forced sync cancelled.")});else if("resync"===r._cmd)$.my.modal({manifest:"cw.Sys.Confirm",data:{text:'<div class=""><span class="fi-alert mr5 fs90 red"></span> DB resync requested. All content of current DB will be discarded on on this machine.  Operation does not remove it on linked machines’ accounts. When process is finished, tab reloads.</div>',ok:"Clean and resync DB"}}).then(function(a){function b(a){return a.replace(/^(http[s]?\:\/\/[^\:@\/]+:)[^@]+(@.+)$/,"$1•••••$2")}if(k(a)&&"commit"==a.cmd){cw.log("Starting ‘"+r.name+"’ destroy+resync.");var c=m[r.name];for(o=0;o<c.sync.length;o++)c.sync[o].dir.forEach(function(a){localStorage.removeItem(["","repl",a,b(c.sync[o].url)].join("_"))});h.destroy(r.name).then(function(){cw.log("DB ‘"+r.name+"’ destroyed for resync, reload scheduled."),window.location.reload()}.debounce(500))}}).fail(function(){t.reject("DB deletion cancelled.")});else if(m[r.name]){var A=m[r.name];for(o=0;o<A.sync.length;o++)p=A.sync[o].url.replace(w,"$1$2"),y[p]=A.sync[o].url;for(o=0;o<r.sync.length;o++)q=r.sync[o].url,q&&(q.has("•••••")?(p=y[q.replace(w,"$1$2")],p&&(r.sync[o].url=p,z.push(r.sync[o]))):z.push(r.sync[o]));m[r.name].sync=z.slice(0),Object.merge(m[r.name],Object.reject(r,"sync")),f(e)}else r.name&&i(r.sync)&&r.title&&r.pic&&(e.dbs.push(Object.clone(Object.select(r,x))),f(e));return t.promise()}},B=function(a,b){return cw.lib.getref(m[a]||{},"sync."+b+".url")},C=function(h){function l(a){var b,c=t(a,f);if(c.dbs&&c.uid||(c=t(a,g),c.dbs&&c.uid||(cw.log("Invalid PIN entered on start."),p.reject("Invalid PIN, can’t decrypt settings"))),c.dbs&&c.uid){o.name=c.name,o.pic=c.pic;try{if(c.pic.length>4e4){var h=new Image;h.src=c.pic,b=cw.lib.image(h),o.pic=b.sharpen(.5).resample(64,64).sharpen(.1).jpeg(.99)}}catch(a){o.pic=c.pic}o.uid=c.uid||cw.lib.hash8(c.name+cw.lib.hash8(c.pin)),o.contact=c.contact||"",o._id=["user",c.name,c.uid].join("-"),o.crc=cw.lib.hash8(c.pic+o._id+o.contact),o.roles=cw.userCtx?cw.userCtx.roles:["_admin"],e=Object.merge({},c),n={},m={};for(var j,k=0;k<e.dbs.length;k++)if(j=e.dbs[k].name,n[j]=Object.clone(e.dbs[k],!0),m[j]=e.dbs[k],i(n[j].sync))for(var l=0;l<n[j].sync.length;l++)n[j].sync[l].url=n[j].sync[l].url.replace(/^(http[s]?\:\/\/[^\:@\/]+:)[^@]+(@.+)$/,"$1•••••$2");cw.debug||(d._getDbSettings=d._settings=d._settings=null,delete d._getDbSettings,delete d._getSyncUrl,delete d._settings),function(){p.resolve(Object.keys(n))}.delay(300)}}var p=a();return k(h)&&/^settings$/.test(h.type)&&h.name||p.reject("Invalid settings doc"),k(e)&&h._rev===e._rev?(p.resolve(Object.keys(n),!0),p.promise()):(h.CRYPTO&&!j(f)?t(h,c("",h.name)).uid?(f=b(""),g=c("",h.name),l(h)):$.my.modal({manifest:{data:{pin:""},init:function(a){a.formgen([{row:"350px",rowCss:"my-row pt20 tac"},'<div class="tac mt15 mb5"><div class="dib vat w260 o80"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0" y="0" width="100%" viewBox="0, 0, 1000, 80">\n  <defs>\n    <linearGradient id="G_0" gradientUnits="userSpaceOnUse" x1="9.905" y1="60" x2="137.96" y2="20">\n      <stop offset="0" stop-color="#ACD6FF"/>\n      <stop offset="0.455" stop-color="#9AC4F5"/>\n      <stop offset="1" stop-color="#7494D0"/>\n    </linearGradient>\n  </defs>\n      <path d="M92,0 C113,-0 128,17 127,35 C145,39 147,51 147,56 C147,71 136,79 122,79 L23,79 C10,79 0,70 0,58 C-0,46 9,38 19,37 C19,20 33,8 50,8 C58,8 63,11 65,13 C66,9 76,0 92,0 z" fill="#FFFFFF"/>\n      <path d="M22,80 L22,79 L21,79 C19,79 17,79 15,78 C9,76 4,72 1,67 C1,66 1,66 1,65 L25,65 L25,80 z M95,80 L95,65 L29,65 L29,80 z M125,80 L125,79 C127,79 127,79 130,79 C132,78 132,78 134,77 C138,75 142,72 144,69 C144,68 145,67 145,66 C146,66 146,65 146,65 L99,65 L99,80 z M147,61 C148,57 147,53 146,49 C145,47 144,46 143,44 C143,43 142,43 142,43 L136,43 L136,61 z M132,61 L132,43 L66,43 L66,61 z M62,61 L62,43 L6,43 C3,46 0,50 0,55 C-0,57 -0,58 0,60 C0,61 0,61 0,61 z M138,39 C138,39 137,39 137,38 C135,37 133,36 131,36 C129,35 129,35 127,35 C127,34 127,33 127,32 C127,28 126,24 125,21 L125,21 L99,21 L99,39 z M95,39 L95,21 L29,21 L29,39 z M25,39 L25,21 L24,21 C24,21 24,21 23,22 C21,26 19,32 19,37 C17,37 17,37 15,38 C13,39 14,38 12,39 z M123,17 C123,16 122,16 122,15 C121,13 119,12 118,10 C112,5 105,1 97,0 C96,0 94,-0 92,0 C86,0 80,1 75,4 C72,5 69,8 66,10 L66,11 L66,17 z M62,17 L62,11 C59,10 58,9 55,9 C54,9 53,8 51,8 C51,8 49,8 48,8 C46,8 44,9 42,9 C37,10 33,13 29,16 C28,16 28,16 28,17 z" fill="url(#G_0)"/>\n    <path d="M268,19 L256,23 Q244,11 223,11 Q207,11 197,19 Q187,27 187,39 Q187,52 197,60 Q207,68 224,68 Q245,68 256,56 L267,62 Q259,71 249,75 Q238,80 223,80 Q203,80 189,69 Q174,58 174,39 Q174,21 189,10 Q203,-0 223,-0 Q252,-0 268,19 z M416,45 Q416,55 408,62 Q400,68 387,68 Q373,68 365,62 Q357,55 357,45 Q357,35 365,29 Q373,22 387,22 Q400,22 408,29 Q416,35 416,45 z M430,45 Q430,30 416,20 Q404,11 387,11 Q369,11 357,20 Q343,30 343,45 Q343,61 357,71 Q369,79 387,79 Q404,79 416,71 Q430,61 430,45 z M519,13 L507,13 L507,54 Q507,68 481,68 Q456,68 456,54 L456,13 L443,13 L443,56 Q443,66 453,73 Q464,79 481,79 Q499,79 509,73 Q519,66 519,56 z M552,66 L552,25 L583,25 Q594,25 600,30 Q607,36 607,46 Q607,55 601,60 Q595,66 585,66 z M540,13 L540,77 L584,77 Q592,77 600,75 Q606,72 610,69 Q621,57 621,45 Q621,31 610,22 Q600,13 582,13 z M739,2 L720,65 L700,2 L684,2 L665,65 L645,2 L631,2 L656,77 L673,77 L692,14 L711,77 L728,77 L753,2 z M783,52 L799,24 L815,52 z M807,13 L791,13 L755,77 L769,77 L777,64 L821,64 L829,77 L843,77 z M916,66 L873,66 L873,13 L860,13 L860,77 L916,77 z M1000,66 L949,66 L949,13 L936,13 L936,77 L1000,77 z M339,66 L296,66 L296,13 L283,13 L283,77 L339,77 z" fill="#719BD3"/>\n</svg></div>',["",'<input id="pin" type="password" placeholder="Enter PIN" class="w250 fs150 tac pt10 pb10 blue" >'],["","btn#btn-ok.fs105.pl20.pr20.mb10.br100",{val:"Decrypt profile"}]]),a.find("#pin").keydown(function(b){13==b.keyCode&&(cw.debug=!1,a.trigger("commit.my")),9==b.keyCode&&(b.preventDefault(),cw.debug=!0,a.trigger("commit.my"))})},ui:{"#pin":"pin","#btn-ok":{bind:function(a,b,c){null!=b&&c.trigger("commit.my")},events:"click.my"}}},width:350,close:!1,css:"p20",esc:!0}).always(function(a){k(a)?(f=b(a.pin),g=c(a.pin,h.name),l(h)):p.reject("No PIN provided to decrypt settings")}):(cw.debug=!0,l(h)),p.promise())};return d={enc:s.fill(),dec:t.fill(),keys:x.fill(),has:w.fill(),att:u.fill(),share:function(){},install:function(){},_init:C.fill(),dblist:z.fill(),me:y.fill(),_getDbSettings:A.fill(),_getSyncUrl:B.fill(),_settings:function(){return e}.fill()},d}());