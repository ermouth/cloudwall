/*CloudWall 2.2.2 core,  (c) 2017 ermouth*/
!function(){function _lock(a){return void 0!==a&&(cw.log(a?"Lock":"Unlock"),Lock.state=!!a,Lock.pi.notify(Lock.state)),Lock.pi.promise()}function _locked(){return Lock.state}function _pi(a){var b=$.Deferred();return b.then(function(a){},function(a,b){}),b}function con(){_logger.apply(null,arguments),cw.debug&&console.log.apply(console,arguments)}function _note(a,b,c){var d=b||"";return $('<div class="'+d+'" style="display:none">'+a+"</div>").prependTo(CW.$notes).slideDown(100).delay(c||3e3).fadeOut(700,function(){$(this).remove()}),con((b?b+": ":"")+a),d}function _qnotify(a){var b,c,d,e=[],f={};for(b in a)if(d=a[b].queue.length){e=a[b].queue.splice(0,d),a[b].revs={},a[b].idxs={},f[b]={};for(c in a[b].types)f[b][c]=[];for(c=0;c<e.length;c++)f[b][""].push(e[c]),void 0!==f[b][e[c].type]&&void 0!==e[c].type&&f[b][e[c].type].push(e[c]);for(c in a[b].types)f[b][c].length||delete f[b][c]}for(b in f)for(c in f[b])a[b].types[c].notify(f[b][c])}function _qchanged(a,b,c){var d,e=a._db;return a.type&&a._db&&a._id&&a._rev?(d=b[e],d.revs[a._id]?(d.queue[d.idxs[a._id]]=a,d.revs[a._id]=a._rev):(d.idxs[a._id]=d.queue.push(a)-1,d.revs[a._id]=a._rev),c(),void 0):null}function i20n(a){return a in CW.i20n?CW.i20n[a]:a}function _encrypt(a){return cw.crypto.enc(lib.dry(a))}function _decrypt(a){return cw.crypto.dec(a)}function _register(a,b){var c,d,e,f,g,h,i,j,k="cw",l=a;if(isS(b)&&(k=b),!isO(l))return null;if(i=$.my.cache(l,b&&"cw"!==b?forms[k]:void 0),!i)return null;if(!(j=l.app)||!l.id||!l.app.name)return null;if(con("Received app "+l.id+" from "+k+", _rev is "+l._rev),dbapps[k][j.name]||(dbapps[k][j.name]={}),Object.merge(dbapps[k][j.name],{name:j.name,id:l.id,pic:l.pic||j.ico,ico:j.ico||l.pic,title:j.title,author:j.author,isEditor:!!j.nodecmd}),isO(l.app.types)&&Object.size(l.app.types)){h=l.app.types,g=l.id;for(e in h)for(types[k][e]||(types[k][e]={}),c=types[k][e],f=0;f<h[e].length;f++)c[h[e][f]]||(c[h[e][f]]=[]),d=c[h[e][f]],d.indexOf(n)===-1&&d.push(g),c[h[e][f]]=d.unique();if("cw"!==k)Object.merge(types[k],types.cw,!0);else for(e in types)"cw"!==e&&Object.merge(types[e],types.cw,!0)}return cw.event("app manifest update"),i}function _urlObserver(){if(!_locked()){var a,b=(window.location.hash||"").replace(/^#/,""),c=cw.state.get();c?a=c.url||"":""==a,c&&(b===a||b===c.initurl)||"undefined"===b||"null"===b||""===b||(con("URL changed from tab bar: ",b),cw.state.set(b).fail(function(a,b){con("Switch fail",a,b),window.location.hash=apps.active||"cw/List"}))}}function _readsaver(){function a(a){read[a]._db="cw",sys.save(read[a],!0).then(function(a){con(a.db+": Saved read state to system db."),read[a.db]._rev=a._rev,read[a.db]._dirty=0},function(b,c){con(read[a]._db+": Failed to save state."),con(b,c)})}for(var b in read)read[b]._dirty&&"cw"!=b&&sys.get(read[b]._id,function(b,c,d){b||c._rev===read[d]._rev?b&&404!==b.status||a(d):(_cmpreads(d,c),a(d))}.fill(void 0,void 0,b))}function _cmpreads(a,b){var c,d,e,f=a,g=[],h=[],i=[],j=read[f].hidden,k=read[f].read,l=read[f].trust||{},d=b.hidden,e=b.read,m=b.trust||{};for(c in d)j[c]||(read[f].hidden[c]=d[c],g.push(c));for(c in e)k[c]&&k[c].rev===e[c].rev||(read[f].read[c]=e[c],h.push(c));for(c in m)l[c]&&l[c].rev===m[c].rev||(read[f].trust[c]=m[c],i.push(c));if(con(a+": New hide/read lists ",g,h),g.length)for(c in g)dbs[f].hide(g[c]);if(h.length)for(c in h)dbs[f].markread(h[c]);read[f]._rev=b._rev}function _ReadHideListDoc(a){return{_id:"db-"+a+"-read",_dirty:0,db:a,type:"readhidelist",name:"Local settings for "+a,read:{},hidden:{},trust:{}}}function _cache(a){var b=a;if(!(isO(b)&&b._db&&b._id&&b._rev))return null;read.hasOwnProperty(b._db)||(read[b._db]=_ReadHideListDoc(b._db));var c,d,e=read[b._db].read,f=read[b._db].hidden,g=ram[b._db];if(b.crypto&&b.CRYPTO&&(cw.crypto.has(b.crypto)||(b._nokey=!0)),f[b._id]||b.parent&&f[b.parent]?b._hidden=!0:!f[b._id]&&b._hidden&&(f[b._id]=!0,read[b._db]._dirty||(read[b._db]._dirty=0),read[b._db]._dirty++),e[b._id]?e[b._id]&&(b._read&&1*b._read.split("-")[0]>1*e[b._id].rev.split("-")[0]?(e[b._id].rev=b._rev,e[b._id].stamp=Date.now(),read[b._db]._dirty||(read[b._db]._dirty=0),read[b._db]._dirty++):e[b._id].rev===b._rev?b._read=b._rev:b._read=""):b._read===b._rev?(e[b._id]={rev:b._rev,stamp:Date.now()},read[b._db]._dirty||(read[b._db]._dirty=0),read[b._db]._dirty++):b._read="",c=g[b._id]){if("manifest"!==b.type&&c._rev===b._rev&&c._read===b._read&&c._hidden==b._hidden&&c._full==b._full&&c._nokey==b._nokey)return c;for(d in g[b._id])delete g[b._id][d]}else ram[b._db][b._id]=Object.extended();if(b._tags={},isA(b.tags))for(d=0;d<b.tags.length;d++)(isS(b.tags[d])||isN(b.tags[d]))&&(b._tags[b.tags[d]]=!0);if(isO(b.otags))for(d in b.otags)b._tags[d]=!0;if(g[b._id].merge(b),Object.merge(tags[b._db],b._tags,!0),"manifest"===b.type&&b.manifest&&b.manifest.id){var h=(_dbsettings(b._db),lib.fuse({},b.manifest,{_id:b._id,_rev:b._rev,_db:b._db}));b._attachments&&(h._attachments=b._attachments,delete appfiles[b._db][b._id]),"cw"===b._db?_register(h,"cw"):b.beta&&b.creator!==me.name&&(!isA(b.log)||b.log[0][2]!==me.name+"-"+me.uid&&b.log.last()[2]!==me.name+"-"+me.uid)||(read[b._db].trust[b._id]!==b._rev&&"*"!==read[b._db].trust[b._id]?Object.merge(h,{_notrust:!0}):Object.merge(h,{_notrust:!1}),_register(h,b._db))}return"user"===b.type&&(users[b._db][b.name+"-"+b.uid]=b.pic),"settings"===b.type&&"cw"===b._db&&"cw"===b._id&&_initCrypto(b).then(function(a,b){b||(con("Received settings update"),_processSettings.delay(2))}),_docChanged(g[b._id]),g[b._id]}function _uncache(a,b){return ram[a]&&ram[a][b]&&!ram[a][b]._hidden?(_docChanged({_deleted:!0,_db:a,_id:b,_rev:ram[a][b]._rev,type:ram[a][b].type}),delete ram[a][b],void 0):null}function _processSettings(a){var b=_pi(),c=cw.crypto.dblist(),d=[],e=0;if(Object.merge(me,cw.crypto.me()),con("User for session "+Session+" is "+me.name+"-"+me.uid),CW.$upic&&me.pic&&(isS(CW.$upic)?$(CW.$upic).attr("src",me.pic):CW.$upic.attr("src",me.pic)),c.length&&me.name){b.then(function(){cw.event("settings update")});var f=function(){con("All local DBs connected"),b.resolve(d)}.after(c.length);(function(){b.resolve(!0)}).delay(CW.dbConnTimeout),c.forEach(function(c){var g=dbs[c];g?(g.sync(!1),function(){g.sync(!0)}.delay(1e3),d.push(c),"cw"===c&&(sys=g),f()):(c!==a&&"cw"!==c?(e+=1,_connect(c,300*e+300)):_connect(c)).then(function(a){(function(){try{a.sync(!0)}catch(a){con(a)}}).delay(500*e+1e3),"cw"===c?(sys=a,sys.load("cw-","cwz","manifest").then(function(b){d.push(a.name),con("System core apps read"),f()}).fail(function(){b.reject(0,"Loading core apps failed")})):(d.push(a.name),f())}.fill(void 0,e)).fail(function(a,b){_note(b,"error"),f()})})}else b.reject(0,"Invalid settings");return b.promise()}function _dbsettings(a,b,c){return _getDbSettings(a,b,c)}function _width(a){var b,c=a.app?a.app:a,d=[],e=0,f=CW.leftWidth,g=CW.rightWidth,h=0;for(d=isA(c.width)&&c.width.length?c.width:d,d=d.map(function(a){return parseInt(a)}).compact(!0),d.length||d.push((CW.maxSpaceWidth||CW.defaultSpaceWidth)-g-f),b=0;b<d.length;b++)e<d[b]&&d[b]<=CW.maxSpaceWidth-g-f&&(e=d[b]);return 0===e&&(e=d.min()),h=e+f+g,h>CW.maxSpaceWidth&&(f=0,h=e+g),h>CW.maxSpaceWidth&&(g=0,h=e),{slot:e,space:h,left:f,right:g}}function _ajax(a,b){var c,d,e=sys.ram(CW.pluginSetDoc)[0];if(e&&(c=e._attachments)&&(d=isS(a)?a:(a||{}).url,d&&!/^http[s]?:\/\//.test(d)&&(d=d.split("/").last(),c[d]))){var f=_pi();return sys.att(CW.pluginSetDoc).data(d).then(function(a){var b,c=a[d].data;try{b=decodeURIComponent(escape(window.atob(c)))}catch(a){b=null}if(b){try{window.eval(b),con("Started local "+d)}catch(a){con("Error starting local "+d,a.message),f.reject("Error initializing local lib "+d)}f.resolve(null)}else f.resolve(null)}),f.promise()}return $.ajax.apply(this,Array.prototype.slice.call(arguments))}function _startCloudwall(){function a(){cw.debug?cw.forms=forms:(delete cw.crypto._getSyncUrl,delete cw.crypto._getDbSettings,delete cw.crypto._settings,delete cw.crypto._init,delete window.PouchDB,delete cw.CW,delete cw.reg,delete cw.start,delete cw.lock,delete cw.read,delete $.my.ajax),Object.freeze(cw.state),window.onbeforeunload=function(){var a=cw.state.slots(),b=0;for(var c in a){var d=a[c].app,e=a[c].$app.my("data");d.isEditor()&&d.crcdoc!==lib.footprint(lib.getref(e,d.nodedoc))&&(b+=1)}return cw.log("~~~ Tab close "+(b?"requested, some docs are unsaved":"")+" ~~~"),b?"Some docs are not saved. Proceed?":void 0},j.resolve(dbs)}function b(){var a,b=_pi(),c=0,d=!1,e=!1;for(var f in dbs)"cw"!==f&&dbs[f].load("user-","userz","user").then(function(f,g){for(;c<f.length&&!d;c++)f[c]._id===me._id&&(d=f[c]);if(!d){var h=_dbsettings(g);for(c=0;c<h.sync.length;c++)h.sync[c].dir.indexOf("to")>-1&&(e=!0)}!e||d&&d.crc===me.crc?b.resolve():(con("User card doesn’t exist or obsolete in "+g+", updating."),a=Object.clone(me,!0),d?(a._rev=d._rev,dbs[g].save(a,!0).always(b.resolve())):(function(){ram[g][me._id]||dbs[g].save(a,!0)}.delay(f.length?1e3:6e5),b.resolve()))}.fill(void 0,f)).fail(function(){b.reject(0,"Loading users from "+f+" failed")}.fill(void 0,f));return b.promise()}function c(){con("Start url observers and savers");var a=_pi();window.location.hash&&"#"!==window.location.hash||(window.location.hash=CW.appDefault);try{setInterval(_readsaver,CW.readStateSaverInterval),setInterval(_urlObserver,CW.urlObserverInterval)}catch(b){a.reject(0,"Observers start failed")}return a.resolve(),a.promise()}function d(){var a=_pi(),b=function(){a.resolve()}.after(2);try{e()}catch(b){a.reject(0,"DOM start failed: "+b)}return CW.$left.my(CW.appLeft,{},{}).then(b).fail(function(b,c){con(b,c),a.reject(0,"Error starting left pane")}),CW.$right.my(CW.appRight,{},{}).then(b).fail(function(b,c){con(b,c),a.reject(0,"Error starting right pane")}),a.promise()}function e(){for(h in CW)if("$"===h.to(1))if("$body"===h&&$(CW[h]).size())CW[h]=$body=$(CW[h]);else{if(!$(CW[h]).length)throw"Unsuitable DOM, some mount points does not exist";CW[h]=$(CW[h])}CW.$upic.attr("src",me.pic),CW.$header.css({display:"none"}),CW.$leftPane=CW.$left.css({width:CW.leftWidth+"px",left:"0px"}).wrap(CW.pane).parent().attr("id","cw-pane-left").css({width:CW.leftWidth+"px",margin:"0 26px 0 -26px"}),CW.leftPaneP=CW.$leftPane.wrap(CW.paneP).parent().append($(CW.paneBtn).css({left:"-42px"})).addClass("dib vat"),CW.leftPaneP.on("click",">.cw-side-hoverpane",function(){var a=$(this);CW.$slots.addClass("cw-shifted").css({width:CW.$slots.width()-CW.leftWidth+"px"}),a.prev().removeClass("hide")}),CW.$rightPane=CW.$right.css({width:CW.rightWidth+"px",right:"0px"}).wrap(CW.pane).parent().attr("id","cw-pane-right").css({width:CW.rightWidth+"px"}),CW.rightPaneP=CW.$rightPane.wrap(CW.paneP).parent().append($(CW.paneBtn).css({left:"10px"})).css({position:"absolute",right:0,top:0}),CW.rightPaneP.on("click",">.cw-side-hoverpane",function(){var a=$(this);CW.$slots.addClass("cw-shifted").css({width:CW.$slots.width()-CW.rightWidth+"px"}),function(){a.prev().removeClass("hide")}.delay(50)}),CW.$slots.css({width:CW.defaultSpaceWidth-CW.rightWidth-CW.leftWidth+"px"}),CW.$space.css({width:CW.defaultSpaceWidth+"px",transition:"width 0.08s",display:"block"}),$(window).on("resize",function(){CW.maxSpaceWidth=$(window).width()-CW.margins,cw.layout()}.debounce(67)),cw.event().progress(function(a){/^slot/i.test(a)&&CW.$right.trigger("update.cw"),/^(slot|db|settings|app)/i.test(a)&&CW.$left.trigger("update.cw")}.debounce(2)),con("End dom prepare")}function f(){var a=_pi();return a.then(function(){$(".cw-Runtime").removeClass("hide"),$(".cw-Static").addClass("hide").html(""),$("#cw-body").addClass("cw"),CW.maxSpaceWidth=Math.max($("body").width()-100,CW.defaultSpaceWidth)}).fail(function(){}),sys.get("cw").then(function(b){con("Settings doc read"),_initCrypto(b).then(function(){con("Settings doc decoded"),a.resolve()}).fail(function(b){a.reject(0,b,"Invalid PIN, access denied")})},function(){a.reject(1,"No settings file")}),a.promise()}function g(){var a=_pi();return i=new Pouch("cw",{size:100}).then(function(b){sys=b,function(){a.resolve(b)}.delay(1),con("Connected to cw")},function(b){a.reject(0,"Fail to connect system DB")}),a.promise()}var h,i,j=_pi(),k=window.location.hash.replace(/^#/,"").split("/")[0]||"cw";return _getSyncUrl=cw.crypto._getSyncUrl,_getDbSettings=cw.crypto._getDbSettings,_getSettings=cw.crypto._settings,_initCrypto=cw.crypto._init,g().then(f).then(function(){return _processSettings(k)}).then(d).then(c).then(b).then(a).fail(function(a,b){_note(b,"error"),j.reject(b)}),j.promise()}var VERSION="2.2.2",$E=$.extend,n=function(a){return null!==a&&void 0!==a},nn=n,N=null,TMP,FN=function(){},ls=localStorage,d8="{yyyy}-{MM}-{dd}",h24="{HH}:{mm}",Ob="object",Da="data",Ar="array",St="string",Fu="function",isA=Object.isArray,isB=Object.isBoolean,isS=Object.isString,isO=Object.isObject,isN=Object.isNumber,isR=Object.isRegExp,isF=Object.isFunction,isP=function(a){return!(null==a||!isO(a)&&!a.jquery||!isF(a.then))},isRej=function(a){return isP(a)?"rejected"===a.state():null},Pouch=window.PouchDB,lib=cw.lib,Session=lib.hash4(Date.now()+" "+Number.random(1e5,1e6)),CW={$body:"#cw-body",$header:"#cw-header",$upic:"#cw-upic",$notes:"#cw-notes",minBodyWidth:1200,margins:100,$space:"#cw-space",maxSpaceWidth:$(window).width()-100,defaultSpaceWidth:1200,$slots:"#cw-slots",$left:"#cw-side",$right:"#cw-dock",leftWidth:180,rightWidth:200,appLeft:"cw.Sys.Side",appRight:"cw.Sys.Dock",appTrust:"cw.Sys.Trust",slot:'<div class="cw-app"></div>',pane:'<div class="cw-pane"></div>',paneP:'<div class="cw-pane-container"></div>',paneBtn:'<span class="cw-side-hoverpane" title="Open panel"><button class="fs110 pt4 pb4 lh100 pl8 pr8 mt4 lgray o80"><span class="fi-list"></span></button></span>',slotTimeout:3e3,slotCloseTimeout:500,slotLayoutDelay:110,appDefault:"cw/List",appToUrlTrackerDebounce:150,urlObserverInterval:333,readStateSaverInterval:15e3,dbWatchersDebounce:5,appNameMask:/^[A-Z][A-Za-z0-9]{2,24}(\.[A-Za-z0-9]{1,25}){0,4}$/,updateURL:"http://cloudwall.me/x/",pluginSetDoc:"cw-Sys-Plugins-4vx1",syncRestart:21e3,dbConnTimeout:3e4,batchSize:5,gcAttsInterval:6e5,i20n:{}},Lock={pi:$.Deferred(),state:!1},$body=$("body"),sys,apps={},forms={cw:{_src:{},_name:"System manifest cache"}},dbapps={cw:{}},appfiles={cw:{}},dbs={},me={type:"user",name:"",pic:"",uid:"",contact:"",crc:"",_id:"",roles:[],locale:(window.navigator.language+"").split("-")[0]},ram={},tags={cw:{}},state={},types={cw:{}},users={},read=Object.extended(),watchers=Object.extended(),_notifyWatchers,_connect,_Events,_docChanged,_getSyncUrl,_getDbSettings,_getSettings,_initCrypto,_att,_logger;cw.TMP||(cw.TMP={}),isF(cw.session)?Session=cw.session():cw.session=function(){return Session},_logger=isF(cw.log)?cw.log:console.log.bind(console),con("~~~ Started session "+Session+" ~~~"),_Events=_pi(),cw.event=function(a,b,c){return isF(a)?(_Events.promise().progress(a),_Events.promise()):isS(a)?(_Events.notify(a,b,c),void 0):_Events.promise()},$.extend(cw.lib,{parseurl:function(a,b){if(!a||!isS(a))return con("--pu--not a tring"),null;var c,d,e,f,g,h={src:"",url:"",initurl:"",db:"",dbtitle:"",app:"",apptitle:"",appid:"",state:"",initstate:"",stateobj:{},cmd:"",cmdtypes:[],docid:"",doctype:""},i=[],j="",k="";if(j=a.has("#")?a.split("#")[1]||"":a+"",j=j.replace(/\/+$/,""),i=j.split("/").compact(!0),i.length<2||i.length>4)return con("--pu--short/long"),null;if(!(c=dbs[i[0]]))return con("--pu--no db"),null;if(h.db=c.name,h.dbtitle=c.title,!(d=cw.form(i[1],c.name)))return con("--pu--no app"),null;if(h.appid=d.id,h.app=d.app.name,h.apptitle=d.app.title,e=d.app,null==i[2]&&(i[2]=""),null===(f=lib.fromurl64(i[2])))return con("--pu--cant fromurl64"),null;if($.type(f)!==$.type(e.maskstate)){if(""!==f)return con("--pu--invalid state"),null;f=lib.mask(d.data,e.maskstate)}else f=lib.unmask(f,e.maskstate);if(null===f)return con("--pu--cant getstate"),null;if(isA(e.maskstate)&&2===e.maskstate.length&&e.maskstate[0]===e.nodecmd&&e.maskstate[1]===e.nodedoc+"._id"){if(h.cmd=lib.mask(f,e.maskstate[0])||"create",h.docid=lib.mask(f,e.maskstate[1])||"",isS(h.cmd)&&isO(e.types)&&Object.keys(e.types).length){for(var l in e.types)isA(e.types[l])&&e.types[l].indexOf(h.cmd)!=-1&&h.cmdtypes.push(l);if(!h.cmdtypes.length)return con("--pu--no such cmd"),null}if("create"===h.cmd){var m,n,o=h.docid,p=lib.uuid();if(o?isO(e.types)&&e.types[o]?m=o:n=o:isO(e.types)&&1===h.cmdtypes.length&&(m=h.cmdtypes[0]),!m&&!n)return con("--pu--cant create"),null;$.extend(!0,f,lib.unmask(p,e.nodedoc+"._id")),h.doctype=m||"",h.oldid=n||"",h.docid=p}else if(!h.docid)return con("--pu--invalid id for cmd"),null}return h.initstate=lib.tourl64(lib.mask(f,e.maskstate)),i[3]?null!==(g=lib.fromurl64(i[3]))&&$.type(g)===$.type(e.maskstate)&&(g=lib.unmask(g,e.maskstate),isO(g)&&$.extend(!0,f,g)):(g=f,h.state=h.initstate),null===g?(con("--pu--cant newstate"),null):(h.state=lib.tourl64(lib.mask(f,e.maskstate)),h.stateobj=Object.clone(f,!0),k=[h.db,h.app,h.initstate].join("/"),h.initurl=k,h.initstate!==h.state&&(k+="/"+h.state),h.url=k,h.src=j,h)}}),_notifyWatchers=_qnotify.fill(watchers).debounce(CW.dbWatchersDebounce),_lock().progress(function(a){a||_notifyWatchers()}),_docChanged=_qchanged.fill(void 0,watchers,function(){_locked()||_notifyWatchers()}),cw.form=function(a,b){function c(a,b,c){if(!e&&CW.appNameMask.test(b)&&b.length<130)for(var d in a)!e&&a[d].hasOwnProperty("app")&&a[d].app.name===b&&(e=$.my.cache(d,c));return e}var d,e=null,f=a;return isS(a)&&a&&(cw.debug?(isS(b)&&dbs[b]&&(d=forms[b]._src,d[a]?e=$.my.cache(a,forms[b]):a.has("/")&&(f=a.split("/")[1]),e=c(d,f,forms[b])),e||(d=$.my.cache(),d[a]?e=$.my.cache(a):a.has("/")&&(f=a.split("/")[1]),e=c(d,f))):(d=$.my.cache(),d[a]?e=$.my.cache(a):a.has("/")&&(f=a.split("/")[1]),e=c(d,f),!e&&isS(b)&&dbs[b]&&(d=forms[b]._src,d[a]?e=$.my.cache(a,forms[b]):a.has("/")&&(f=a.split("/")[1]),e=c(d,f,forms[b])))),e},cw.layout=function(a,b){var c=isO(a)&&a.app?a:cw.state.get(),d=b||_width(c.app);Object.merge(c.width,d),c.$app.width(d.slot),CW.$leftPane.toggleClass("hide",!d.left),CW.$space.width(d.space),CW.$body.width(d.space),CW.$slots.removeClass("cw-shifted").width(d.slot),CW.$rightPane.toggleClass("hide",!d.right),c.notify("layout")},function(a){function b(a,b){function d(a,b){_lock(!0);var d=c.slot[a];if(d)for(var e in d.attctr)d.attctr[e]>0&&_att(d.db.name,e).free(d.attctr[e]+1);var f=CW.$slots.find("#"+b);delete c.status[b],delete c.slot[a];var h;try{h=$.extend(!0,{},f.my("remove"),!0)}catch(a){}f.remove(),cw.log("App "+d.url+" closed"),d=null,_lock(!1),cw.event("slot close"),g.resolve(h)}var e,f,g=_pi();if(f=c.slot[a])if(e=f.domid,f.closing=!0,cw.log("Closing "+f.url),c.active!==a)c.status[e].notify("close"),d.delay(CW.slotCloseTimeout,a,e);else{var h=0,i="";for(var j in c.slot)j!==a&&c.slot[j].app.updated>h&&(h=c.slot[j].app.updated,i=j);h||(i=CW.appDefault),c.status[e].notify("close"),_lock(!0),CW.$slots.find("#"+e).animate({opacity:.3},100,null,function(){var b=window.location.href.split("#")[0]+"#"+i;window.history.replaceState(null,null,b),_lock(!1),cw.state.set(i).always(function(){d.delay(CW.slotCloseTimeout,a,e)})})}return g.promise()}var c=(_pi(),Object.merge(apps,{slot:{},active:"",status:{}}));Object.merge(a,{get:function(){return c.slot[c.active]},slots:function(a){return isS(a)?c.slot[a]:c.slot},url:function(){return c.active},set:function(a,d){function e(){var a,b,c,d,e=_pi(),f=!1,g={},h=[];if("cw"===w._db)e.resolve();else{read[r.db].trust||(read[r.db].trust={},f=1),c=read[r.db].trust,b=(d=u.ram(function(a){return"manifest"===a.type&&a.manifest&&(a.manifest.id===r.appid||a.manifest.id.startsWith(r.appid+"."))})).reduce(function(a,b){return a[b._id]=b._rev,g[b._id]=b,a},{});for(a in b)"*"!==c[a]&&c[a]!==b[a]&&h.push({id:g[a].id,_id:g[a]._id,_rev:g[a]._rev});h.length?(cw.log("Confirm trust modal"),$.my.modal({manifest:CW.appTrust,data:{trust:h.sortBy("id")}}).then(function(a){if(isO(a)){for(var b=0;b<a.trust.length;b++)c[a.trust[b]._id]=a.trust[b]._rev;for(a.trust.length&&(read[r.db]._dirty=!0),cw.lib.unjson(w),b=0;b<h.length;b++){var d=Object.clone(ram[w._db][h[b]._id],!0);_cache(d)}cw.log("Trust confirmed"),e.resolve()}else e.reject(1,"App start terminated by user.")}).fail(function(){cw.log("App trust rejected by user"),e.reject(1,"App start terminated by user.")})):e.resolve()}return e.promise()}function f(){var a=_pi();if(r.cmd)if("create"!==r.cmd||r.oldid){var b=ram[r.db][r.oldid||r.docid];b?(u.markread(b._id),a.resolve(b,"isInvalid")):u.load([r.oldid||r.docid]).then(function(b){a.resolve(b[0],"isInvalid")}).fail(function(){a.reject(1,"Reading doc "+(r.oldid||r.docid).truncate(50)+" failed.")})}else!function(){var b={type:r.doctype,_id:r.docid};a.resolve(b,"isAppCapable")}();else a.resolve(null,"getAppResources");return a.promise()}function g(a,b){var c=_pi();return b&&"isInvalid"!=b?(c.resolve(a,b),c.promise()):(a?a._nokey?c.reject(1,"Doc <b>"+(a.title||a.name||a._id)+"</b> is encrypted with key "+a.crypto+", which is not installed."):a.crypto?c.resolve(_decrypt(a)):c.resolve(a):c.reject(1,"Doc "+(r.oldid||r.docid)+" not found in DB "+u.name+"."),c.promise())}function h(a,b){var c=_pi();if(b&&"isAppCapable"!=b)return function(){c.resolve(a,b)}.delay(1),c.promise();var d,e=a.type;return r.cmdtypes.indexOf(e)>-1||r.cmdtypes+""=="*"?(d=$.extend(!0,{},a),"create"===r.cmd&&(delete d._rev,d._cloned=r.oldid,d._id=r.docid),Object.merge(w.data,lib.unmask(d,w.app.nodedoc),!0),c.resolve(a)):c.reject(1,"App "+w.app.name+" can not "+r.cmd+" doc of type "+e+"."),c.promise()}function i(a,b){var c,d,e,f=_pi();return b&&"getAppResources"!=b?(f.resolve(a,b),f.promise()):(w._attachments&&w._id&&w._db?(c=w._attachments,d=w._db,e=w._id,appfiles[d][e]?(w.files=Object.clone(appfiles[d][e]),f.resolve(a)):(appfiles[d][e]={},_att(d,e).url(),_att(d,e).data().then(function(b){appfiles[d][e]=b,w.files=Object.clone(appfiles[d][e]),f.resolve(a)}).fail(function(){f.resolve(a)}))):f.resolve(a),f.promise())}function j(){var a=_pi();return Object.merge(w.data,r.stateobj,!0),Object.merge(w,{params:{cache:function(a){return dbs[r.db].form(a)}}},!0),x="cw-app-"+lib.hash8(q+Number.random(1e12)),y=$(CW.slot),y.attr("id",x),s=_width(w.app),y.addClass("cw-app-init").width(s.slot),y.prependTo(CW.$slots),z=$.Deferred(),z.progress(function(a,b){var d,e,f;(d=c.slot[b])&&("active"==a?(D=!0,c.active=b,e=d.app,f=_width(e),cw.layout(d,f),d.app.updated=Date.now(),function(){y.removeClass("hide cw-app-init").addClass("cw-app-active");try{y.my("restyle")}catch(a){console.log(a)}if(d.caret)try{cw.lib.scroll(d.caret.top,80),d.caret.$node.focus(),cw.lib.caret(d.caret.$node,d.caret.pos)}catch(a){}cw.event("slot open")}.delay(f.left?0:CW.slotLayoutDelay)):"inactive"===a?($.my.modal(!0),D=!1,y.removeClass("cw-app-active").addClass("hide")):"close"===a&&c.active===b&&$.my.modal(!0))}.fill(void 0,r.initurl)),c.status[x]=z,w=o(w,u,z,r),E=w.app.isEditor(),a.resolve(w),a.promise()}function k(a){var b=_pi();return C?b.reject(1,"App "+q+" init failed."):(function(){"pending"===B.state()&&p(0,"App "+q.truncate(50)+" init timeout.")}.delay(1*a.app.timeout||CW.slotTimeout),cw.log("Init $.my "+a.id),y.my(a).then(function(){cw.log("Started "+a.id),b.resolve()},function(a,c){b.reject(a,"App "+q+" init failed.")})),b.promise()}function l(){var a,b=_pi();return a=c.slot[r.initurl]={$app:y,domid:x,attctr:F,name:w.app.name,db:w.db,app:w.app,url:r.url,initurl:r.initurl,initstate:r.initstate,notify:function(a){z.notify(a)}.debounce(0),width:s,title:lib.mask(w.data,w.app.nodetitle)||w.app.title},y.data("app",a),t=c.slot[c.active]?c.slot[c.active].domid:null,t&&t!==x&&c.status[t].notify("inactive"),z.notify("active"),b.resolve(a),b.promise()}function m(a){var b=_pi();return y.on("change",function(){if(D&&y.is(".cw-app-active")&&!_locked()){var b=y.my("data"),c=w,d=lib.mask(b,c.app.nodetitle)||c.app.title,e=c.app.maskstate?lib.tourl64(lib.mask(b,c.app.maskstate)):null,f="",g=[u.name,a.name,a.initstate,e&&e!==a.initstate?e:void 0].compact().join("/");document.title==d&&g===a.url||(a.app.updated=Date.now()),E||g===a.url||(a.app.url=a.url=g,a.app.state=e?e:null,f=window.location.href.split("#")[0]+"#"+g,window.history.replaceState(null,null,f)),document.title!=d&&(document.title=d,a.title=d,CW.$right.trigger("update.cw"))}}.debounce(CW.appToUrlTrackerDebounce)),y.on("click",function(){var a=y.data("app").width;CW.$slots.is(".cw-shifted")&&(a.left||CW.$leftPane.addClass("hide"),a.right||CW.$rightPane.addClass("hide"),function(){CW.$slots.width(a.slot).removeClass("cw-shifted")}.delay(50))}.debounce(50)),y.on("commit",function(a){a.stopPropagation(),w.db.save().then(function(a){Object.merge(lib.getref(w.data,w.app.nodedoc),a,!0),y.my("redraw"),w.app.crcdoc=lib.footprint(lib.getref(w.data,w.app.nodedoc))})}),y.on("cancel",function(a){a.stopPropagation(),w.app.close()}),b.resolve(a),b.promise()}function n(a){var b=_pi();if(r.cmd){"create"!==r.cmd&&u.markread(r.docid);try{w.app.crcdoc=lib.footprint(lib.getref(w.data,w.app.nodedoc))}catch(a){}}return b.resolve(a),b.promise()}function o(a,c,e,f){var g,h,i,j={},k=c.name,l=!1,m=Object.select(c,["get","put","query","sync","app","actions","del","find","hide","tags","inram","isread","markread","ram","settings","users","uuid"]);g=j[k]={queue:[],revs:{},idxs:{},types:{"":$.Deferred()}},Object.merge(m,{watch:function(a){var b=a||"";return g.types[b]||(g.types[b]=$.Deferred()),g.types[b].promise()},form:function(a){var b=c.form(a);return b},info:function(a){return c.info(a||function(){})},name:c.name,title:function(){return _dbsettings(k).title},load:function(){var b=!1,d=c.load.apply(a,arguments),e=function(){d&&d.status&&"pending"!==d.status()||(b=!0,a.app.busy(!0))}.delay(200);return d.always(function(){b?a.app.busy(!1):e.cancel()}),d},save:function(b,d){function e(a){a.hasOwnProperty("CRYPTO")?h.resolve(_decrypt(a)):h.resolve(a)}var f,g=!1,h=_pi(),i=l&&null==b,j=function(){h&&h.status&&"pending"!==h.status()||(g=!0,a.app.busy(!0))}.delay(200);return i?(f=lib.getref(a.data,a.app.nodedoc),f.stamp=Date.now(),c.save.call(a,f,d).then(e).fail(function(a,b){h.reject(a,b)})):c.save.apply(a,arguments).then(e).fail(function(a,b){h.reject(a,b)}),h.then(function(b){!l||b._id!==lib.getref(a.data,a.app.nodedoc)._id&&"create"!==lib.getref(a.data,a.app.nodecmd)||(a.app.crcdoc=lib.footprint(b))}),h.always(function(){g?a.app.busy(!1):j.cancel()}),h.promise()},att:function(a){var b=_att(k,a);return b?(F[a]||(F[a]=0),F[a]+=1,Object.merge({free:function(){return F[a]-=1,F[a]<1&&(F[a]=0,b.free()),!0}},Object.reject(b,"free"))):null}}),i=_qnotify.fill(j).debounce(1),h=_qchanged.fill(void 0,j,function(){D&&i()}),c.watch("").progress(function(a){if(isA(a))for(var b=0;b<a.length;b++)h(a[b])}),e.progress(function(a){"active"===a&&i()});var n=a.app.maskstate;return l=isA(n)&&2===n.length&&n[0]===a.app.nodecmd&&n[1]===a.app.nodedoc+"._id",l&&(a.cmd=r.cmd,a.docid=r.docid),Object.merge(a.app,{domid:x,url:r.url,initurl:r.initurl,caller:d||"",state:r.state,born:Date.now(),updated:Date.now(),isActive:function(){return D},isEditor:function(){return l},busy:function(a){return null==a?y.is(".cw-app-busy"):(y.toggleClass("cw-app-busy",!!a),void 0)},layout:_width.fill(a),trigger:function(a){y.trigger(a)},run:function(b){return cw.state.set(b,a.app.starturl)},watch:e?e.promise():null,local:function(b,c){var d,b=a.id+"/"+b;return void 0===c?JSON.parse(ls.getItem(b)):null===c?(d=JSON.parse(ls.getItem(b)),ls.removeItem(b),d):(ls.setItem(b,JSON.stringify(c)),void 0)},modal:function(a){var b=_pi(),c=a;return isO(c)&&c.manifest?(c=Object.merge({},a,!0),isS(c.manifest)&&(c.manifest=dbs[r.db].form(c.manifest)),Object.merge(c.manifest,{params:{cache:function(a){return dbs[r.db].form(a)}}},!0),$.my.modal(c)):b.reject(null)},close:function(c,d){var e,f,g=_pi();return g.fail(function(a){_note(a)}),l&&!d&&($.my.modal(!0),f=lib.getref(a.data,a.app.nodedoc),e=lib.footprint(f),e!==a.app.crcdoc)?($.my.modal({manifest:"cw.Sys.YesNoCancel",data:{text:'<span class="fi-alert o70 mr5 fs90" ></span> Doc has unsaved changes.',yes:'<span class="fi-save fs90" ></span> Save and close',no:'<span class="fi-x-circle fs90" ></span> Discard and close'},esc:!0,width:500}).then(function(a){isO(a)?("yes"===a.cmd&&m.save(f).then(function(){b(r.initurl,c).then(function(a,b){g.resolve(a,b)}).fail(function(a,b){g.reject(a,b)})}).fail(function(){g.reject("Save failed")}),"no"===a.cmd&&b(r.initurl,c).then(function(a,b){g.resolve(a,b)}).fail(function(a,b){g.reject(a,b)})):g.reject("Cancelled")}).fail(function(){g.reject("App close cancelled")}),g.promise()):b(r.initurl,c)},me:function(a){return cw.me(a)}}),a.db=m,a.attctr=F,a}function p(a,b){C||(cw.log("Appswitch failed",a,b),y&&y.remove(),z&&z.reject(),B.reject(a,b)),C=!0}var q,r,s,t,u,v,w,x,y,z,A,B=_pi(),C=!1,D=!1,E=!1,F={};return _locked()?(p(0,"System locked."),B.promise()):isS(a)?(B.always(function(){_lock(!1)}),B.fail(function(a,b){_note(b,"error")}),B.then(function(a){window.location.hash=a.app.url}),_lock(!0),r=lib.parseurl(a),r?(q=r.url,cw.log("Appswitch: ",a,d),(A=c.slot[q]||c.slot[r.initurl]||c.slot[a])?(x=A.domid,t=c.slot[c.active].domid,t!==x&&c.status[t].notify("inactive"),c.status[x].notify("active"),q!==A.initurl&&q!==A.url&&A.$app.my("data",r.stateobj),B.resolve(A).promise()):(u=dbs[r.db],w=dbs[r.db].form(r.appid),v=_dbsettings(r.db),e().then(f).then(g).then(h).then(i).then(j).then(k).then(l).then(m).then(n).then(function(a){$(document).scrollTop(0),cw.log("Appswitch success"),B.resolve(a)}).fail(function(a,b){p(a,b)}),B.promise())):(p(1,"Invalid params for slot switch."),B.promise())):(p(1,"Invalid params type for slot switch."),B.promise())}})}(state),function(a){var b={},c={},d={};_att=function(a,e){function f(a,b){var c=_pi();return g(a,b,function(a,b){c.resolve(a,b)}),c.promise()}function g(a,b,c){var d=i(a),f={},g=l._attachments,k=function(){(isF(c)?c:FN)(f)}.after(d.length);d.reduce(function(a,c){var d=Object.reject(g[c],"data");return j[c]&&j[c][0]===d.revpos?h(d,j[c][1],b,c).always(function(b){a[c]=b,k()}):m.getAttachment(e,c,function(e,f){e?k():h(d,f,b,c).always(function(b){a[c]=b,k()})}),a},f)}function h(a,b,c,d){var e=_pi();return j[d]&&j[d][0]===a.revpos||(j[d]=[a.revpos,b]),a.size=b.size,"blob"===c?(a.blob=b,e.resolve(a,a.blob)):"url"===c?(k[d]&&k[d][0]===a.revpos?a.url=k[d][1]:(k[d]&&URL.revokeObjectURL(k[d][1]),k[d]=[a.revpos,URL.createObjectURL(b)],a.url=k[d][1],a.blob=b),e.resolve(a,a.url)):"data"===c?lib.blob2base64(b,function(c){a.data=c,a.blob=b,e.resolve(a,c)}):"image"===c&&lib.blob2base64(b,function(c){a.image=c,a.blob=b,e.resolve(a,c)},!0),e.promise()}function i(a){var b,c=l._attachments;if(!isO(c))return[];if(null==a)return Object.keys(c);if(isS(a))b=[a];else if(isA(a))b=a;else if(isO(a))b=Object.keys(a);else if(isF(a))b=Object.keys(Object.findAll(c,a));else{if(!isR(a))return[];b=Object.keys(c).filter(a)}return b.findAll(function(a){return!!c[a]})}if(!ram[a]||!ram[a][e])return null;var j,k,l=ram[a][e],m=dbs[a];return b[a]||(b[a]={},c[a]={},d[a]={}),b[a][e]||(b[a][e]={},c[a][e]={},d[a][e]=0),j=b[a][e],k=c[a][e],d[a][e]++,{blob:f.fill(void 0,"blob"),url:f.fill(void 0,"url"),data:f.fill(void 0,"data"),image:f.fill(void 0,"image"),free:function(b){d[a][e]-=isNaN(b)?1:0|b,d[a][e]<0&&(d[a][e]=0),d[a][e]<1&&function(){d[a][e]<1&&_att.flush(a,e)}.delay(CW.gcAttsInterval)}}},Object.defineProperty(_att,"flush",{value:function(a,d){if(b[a]&&b[a][d]){var e,f=b[a][d],g=c[a][d];for(e in f)delete f[e];for(e in g)URL.revokeObjectURL(g[e][1]),delete g[e];return!0}return!1}})}(cw),_connect=function(id,postpone){function _setViews(a){function b(b){a.put(b).then(function(){con(dbid+": updated views in _design/cloudwall ddoc."),e.resolve()},function(a){d?con(dbid+": failed to write update for ddoc, proceeding with old ddoc and views."):e.reject("Can’t update design doc for DB "+dbid+".")})}var c,d,e=_pi(),f={_id:"_design/cloudwall",language:"javascript",views:{},type:"ddoc",options:{local_seq:!0,include_design:!0}},g=($.my.cache("cw.Sys.Db.List")||{}).views;if(g&&Object.size(g)){for(c in g)f.views[c]={},g[c].map&&(f.views[c].map=g[c].map.toString()),g[c].reduce&&(f.views[c].reduce=g[c].reduce.toString());
a.get("_design/cloudwall").then(function(a){d=a,Object.equal(Object.select(a.views,Object.keys(f.views)),f.views)&&a.type==f.type&&Object.equal(a.options,f.options)?e.resolve():($.extend(!0,f,Object.reject(a,["language","views","options"])),$.extend(!0,f.views,Object.reject(a.views,Object.keys(f.views))),b(f))},function(a){a.status&&404!=a.status?e.reject("Can’t read design doc for DB "+dbid+"."):b(f)})}return e.promise()}function _replicator(a,b){function c(a,g,h,i){function m(f){u||v||w||(n[e(g)]=!(!f&&!i)&&Date.now()+6e4*(f||i),u=!0,d(c.fill(a,g,h,i),f||i),void 0===f?cw.event("db replication failed",b):cw.event("db replication finished and rescheduled",b))}var p=!1,q=h.indexOf("to")!=-1,r=h.indexOf("from")!=-1,s=i?{batch_size:CW.batchSize||10}:{continuous:!0,live:!0,heartbeat:15e3,timeout:45e3,batch_size:CW.batchSize||10},t=i?{batch_size:CW.batchSize||10}:{continuous:!0,live:!0,heartbeat:15e3,timeout:45e3,batch_size:CW.batchSize||10},u=!1,v=!1,w=!1;if("stop"===l)return con(b+": replication stopped, restart supressed."),!0;if(!navigator.onLine)return con(b+": replication failed, browser is offline."),m(),!0;o[g]||(o[g]=Pouch(g,{ajax:{timeout:6e5,cache:!0}}));try{k[g]&&k[g].cancel(),r&&(i&&(f("from",e(g))?Object.merge(t,{since:f("from",e(g)).seq}):Object.merge(t,{since:0})),w=!0,k[g]=a.replicate.from(o[g],t,function(a,c){w=!1,a&&!i?(v=!1,m(.5),con(b+": sync-in closed.",a,c)):a?(m(i),con(b+": sync-in failed, next cycle scheduled.",a,c)):m(i),c&&c.last_seq&&f("from",e(g),{seq:c.last_seq,stamp:Date.now()})}))}catch(a){p=!0,w=!1}try{if(j[g]&&j[g].cancel(),q&&!p){if(i)if(f("to",e(g))){var x=f("to",e(g)).seq;Object.merge(s,{since:isNaN(x)?0:+x})}else Object.merge(s,{since:0});v=!0,j[g]=a.replicate.to(o[g],s,function(a,c){v=!1,a&&!i?(w=!1,m(.5),con(b+": sync-out closed.",a,c)):a?(m(i),con(b+": sync-out failed, next cycle scheduled.",a,c)):m(i),c&&c.last_seq&&f("to",e(g),{seq:c.last_seq,stamp:Date.now()})})}}catch(a){p=!0,v=!1}return n[e(g)]=!p,p?(cw.event("db replication start failed",b),con(b+": sync failed, restart required."),m()):(cw.event("db replication started",b),con(b+": sync (re)started.")),p}function d(a,b){var c;g||"start"!==l||(c=a.delay(6e4*b||CW.syncRestart),m.add(c,0)),m.length>50&&m.splice(50)}function e(a){return a.replace(/^(http[s]?\:\/\/[^\:@\/]+:)[^@]+(@.+)$/,"$1•••••$2")}function f(a,b,c){return c?(localStorage.setItem("_repl_"+a+"_"+b,cw.lib.json(c)),void 0):cw.lib.unjson(JSON.parse(localStorage.getItem("_repl_"+a+"_"+b)))}var g=!1,h=!1,i=_dbsettings(b),j={},k={},l="stop",m=[],n={},o={};$.extend(ext,{sync:function(d){var e,f,g=0;if(null==d)return n;if(m.forEach(function(a){a.cancel()}),m=[],d){for(l="warm",i=_dbsettings(b),e=0;e<i.sync.length;e++)f=i.sync[e].dir,isA(f)&&f.length&&(g+=c(a,_getSyncUrl(b,e),f.slice(0),1*i.sync[e].interval||0)?1:0);g||(h=!0),l="start"}else{l="stop",con("Replication of "+b+" stopping...");for(e in k)k[e].cancel();for(e in j)j[e].cancel();for(e in n)n[e]=!1;cw.event("db replication stopped",b)}return n}})}function _extdb(db,dbid){var i,rd=ram[dbid],slice=Array.prototype.slice,title="",dbset=_dbsettings(dbid);ext={name:dbid,title:function(){return _dbsettings(dbid).title},settings:_dbsettings.fill(dbid),actions:function(a){return isS(a)?(types[dbid]||{})[a]||{}:null==a?types[dbid]||{}:{}},form:function(a){return cw.form(a,dbid)},app:function(a){return null==a?"cw"===dbid?Object.keys(dbapps[dbid]).sort():Object.keys(dbapps.cw).union(Object.keys(dbapps[dbid])).sort():"cw"===dbid?Object.clone(dbapps[dbid][a],!0):Object.clone(dbapps[dbid][a]||dbapps.cw[a],!0)},att:function(a){return _att(dbid,a)},save:function(a,b){function c(a){db.put(a,function(e,f){e?"409"!=e.status||b?(con("Error saving "+d._id+" into "+ext.name,e.message,e.stack),j.reject(e,"DB failed on doc "+d._id+". Save aborted.")):$.my.modal({manifest:"cw.Sys.Confirm",data:{text:'<span class="fi-alert o70 mr5 fs90"></span> Conflict: document was updated externally while edit. Saving doc will overwrite external changes.',ok:"Overwrite"}}).then(function(b){isO(b)&&"commit"===b.cmd?db.allDocs({startkey:d._id,endkey:d._id}).then(function(b){var f=b.rows;f&&f.length?(a._rev=f[0].value.rev,c(a)):(j.reject(e,"Conflict on doc "+d._id+". System error during overwrite"),con("Doc read on overwite is",b))},function(){j.reject(e,"Conflict on doc "+d._id+". Overwrite failed reading new revision id.")}):(con("Save of "+d._id+" into "+ext.name+" was cancelled, conflict",e.message,e.stack),j.reject(e,"Conflict on doc "+d._id+". Save cancelled."))}).fail(function(){con("Save of "+d._id+" into "+ext.name+" was aborted, conflict",e.message,e.stack),j.reject(e,"Conflict on doc "+d._id+". Save failed.")}):db.get(f.id,function(a,c){var e=c;a?j.reject(a,"Error reading doc "+d._id+" after save."):(e._read=e._rev,e._db=dbid,e=_cache(e),j.resolve(e),b||_note((e.type||"Doc").capitalize()+" "+(d.name||d._id)+" saved.","ok"))})})}cw.debug&&b&&console.log("Silent save request",a);var d,e,f,g,h,i,j=_pi();if(j.fail(function(a,c){b||_note(c,"error")}),isO(a))if(a.CRYPTO)j.reject({},"Cannot save pre-encrypted.");else if(a.name&&a.type)if("cw"===a._id&&"cw"===dbid)j.reject({},"Saving system settings is forbidden using .save() method.");else{if(d=Object.clone(Object.reject(a,"_attachments"),!0),e=isA(d.log),f=!d._id||!d._rev,a._attachments&&Object.size(a._attachments)){d._attachments={};for(var k in a._attachments)h=a._attachments[k],h.data?d._attachments[k]=Object.select(h,["data","content_type"]):d._attachments[k]=Object.select(h,["content_type","digest","revpos","stub"])}f?(d.stamp=Date.now(),d._id=d._id||lib.uuid(me.name),delete d._rev,e&&(d.log=[[Date.now(),"create",me.name+"-"+me.uid,1,dbid]]),d.creator=d.creator||me.name+"-"+me.uid):e&&(i=me.name+"-"+me.uid,(!d.log.length||d.log[0][2]!=i||Date.now()-d.log[0][0]>6e5)&&d.log.add([[Date.now(),"update",i,1*d._rev.split("-")[0]+1,dbid]],0),d.log.length>50&&(d.log=d.log.to(49).add([d.log.last()]))),g=_encrypt(d),c(g)}else j.reject({},"Undefined name or type.");else j.reject({},"No doc to save.");return j.promise()},load:function(a,b,c){var d,e=_pi(),f=[],g=ram[dbid];if(isA(a))a.length||e.resolve([]),f=a.map(function(a){var b=a+"";if(n(a)&&b.length>0)return b}).compact(),d=isS(b)?b:null,db.allDocs({keys:f,include_docs:!0,conflicts:!0},function(a,b){var c,f=[],g=0;if(a)e.reject(a,"Error reading docs by keylist.");else if(b.rows.length){for(;g<b.rows.length;g++)!b.rows[g].doc||d&&b.rows[g].doc.type!==d||(b.rows[g].doc._db=dbid,c=_cache(b.rows[g].doc),n(c)&&f.push(c));e.resolve(f)}else e.resolve([])});else if(isS(a)&&(void 0===b||isB(b)))g.hasOwnProperty(a)&&g[a]._full?g[a]._deleted||g[a]._hidden?e.resolve(null):e.resolve(g[a]):db.get(a,{attachments:b,conflicts:!0},function(a,c){var d=c;a?e.resolve(null):(d._db=dbid,d._full=!!b,d=_cache(d),e.resolve(d))});else if(isS(a)&&isS(b)){var h=a,i=b,j=!1;a>b&&(h=b,i=a,j=!0),d=isS(c)?c:null,db.allDocs({startkey:h,endkey:i,descending:j,include_docs:!0,conflicts:!0},function(a,b){var c,f=[],g=0;if(a)e.reject(a,"Error reading docs by keylist.");else if(b.rows.length){for(;g<b.rows.length;g++)(!d||b.rows[g].doc&&b.rows[g].doc.type===d)&&(b.rows[g].doc._db=dbid,c=_cache(b.rows[g].doc),n(c)&&f.push(c));e.resolve(f)}else e.resolve([])})}return e.promise()},ram:function(a){var b,c=[];if(isS(a)&&rd[a])c.push(rd[a]);else if(isA(a))for(b=0;b<a.length;b++)rd.hasOwnProperty(a[b])&&c.push(rd[a[b]]);else if(isF(a))try{for(b in rd)a(rd[b])&&c.push(rd[b])}catch(a){}return c},inram:function(a){return isS(a)&&rd.hasOwnProperty(a)},tags:function(){return Object.keys(tags[dbid]).sort()},find:function _dbFind(A1,A2,A3){var pi=_pi(),params={},sort=null,reverse=!1,rnd,fn,filter=A1,start,end,str;return isO(A2)&&(isF(A1)||isS(A1))&&(void 0!==A2.start&&void 0!==A2.end&&(start=A2.start,end=A2.end,reverse=!1,start>end&&(start=A2.end,end=A2.start,reverse=!0),params.startkey=start,params.endkey=end),isF(A2.sort)&&(sort=A2.sort)),isO(A1)&&A1.filter&&(filter=A1.filter,void 0!==A1.start&&void 0!==A1.end&&(start=A1.start,end=A1.end,reverse=!1,start>end&&(start=A1.end,end=A1.start,reverse=!0),params.startkey=start,params.endkey=end),isF(A1.sort)&&(sort=A1.sort)),isS(filter)&&(str=filter,filter=function(a){return a.type===str?a._id:null}),isF(filter)?(rnd=Date.now()+"-"+Number.random(1e6),cw.TMP[rnd]=filter,fn=eval('(function(d){var k=cw.TMP["'+rnd+'"](d);if(undefined!==k&&null!==k)emit(k,d);})'),null===sort&&(isF(A2)||isS(A2))&&(sort=A2,reverse=!!A3),db.query(fn,params,function(a,b){delete cw.TMP[rnd];var c,d=[],e=0;if(a)pi.reject(a,"Error searching docs.");else if(b.rows.length){for(;e<b.rows.length;e++)b.rows[e].value._db=dbid,c=_cache(b.rows[e].value),n(c)&&d.push(c);pi.resolve(null!==sort?d.sortBy(sort,reverse):d)}else pi.resolve([])})):pi.reject({},"No filter function provided."),pi.promise()},watch:function(a){var b=a||"";return watchers[dbid].types[b]||(watchers[dbid].types[b]=$.Deferred()),watchers[dbid].types[b].promise()},markread:function(a){var b=ram[dbid][a],c={};return"cw"===dbid?null:b&&b._rev!==b._read?(c=$.extend(c,b),c._read=c._rev,_cache(c)):b},isread:function(a){return"cw"===dbid?null:read[dbid].read[a]||null},hide:function(a){var b=ram[dbid][a],c={};return"cw"===dbid?null:b&&!b._hidden?(c=$.extend(c,b),c._hidden=!0,_cache(c)):b},uuid:function(a){return lib.uuid(a)},users:function(a){return users[dbid]},del:function(a){var b=ram[dbid][a],c=_pi();return"cw"===dbid&&"cw"==a?c.reject("Settings can not be deleted"):b&&!b._hidden&&db.remove(b,function(a,d){a?(con(a),c.reject("Fail to delete doc "+(b.title||b.name))):c.resolve(!0)}),c.promise()},replicate:{to:db.replicate.to.bind(db),from:db.replicate.from.bind(db)}};for(i in db)ext[i]||isF(db[i])&&(ext[i]=db[i].bind(db));return dbs[dbid]=ext}var ext,db,dbid=id+"",pi=_pi();return dbs[dbid]?pi.resolve(dbs[dbid]):db=new Pouch(dbid,{size:100},function(a,b){function c(){!sys||!sys.load||read[dbid]&&Object.size(read[dbid].read)?(_extdb(db,dbid),e()):(con(dbid+": reading read and hidden list"),sys.load(["db-"+dbid+"-read"]).then(function(a){a.length&&(read[dbid]=a[0])},function(a,b){con(a,b)}).always(function(){_extdb(db,dbid),postpone?(setTimeout(d,postpone),e()):d().always(e)}))}function d(){return ext.load("cw-","cwz","manifest").then(function(a){a.length&&con("Read "+a.length+" manifest"+(a.length>1?"s":"")+" from DB "+dbid+".")})}function e(){_replicator(db,dbid),pi.resolve(dbs[dbid])}a?pi.reject(a,"Connection to DB "+dbid+" failed."):(con(dbid+": DB connected"),watchers[dbid]||(watchers[dbid]={queue:[],revs:{},idxs:{},types:{"":$.Deferred()}}),users[dbid]||(users[dbid]={}),forms[dbid]||(forms[dbid]={_src:{},_name:"DB "+dbid+" manifest cache"}),types[dbid]||(types[dbid]=Object.clone(types.cw,!0)),ram[dbid]||(ram[dbid]=Object.extended()),read[dbid]||(read[dbid]=_ReadHideListDoc(dbid)),dbapps[dbid]||(dbapps[dbid]={}),appfiles[dbid]||(appfiles[dbid]={}),tags[dbid]||(tags[dbid]={}),db.info(function(a,b){function c(a){a.changes&&a.changes[0]&&a.changes[0].rev&&(!ram[dbid][a.id]||ram[dbid][a.id]._rev!=a.changes[0].rev)&&(con(dbid+": changes in "+a.id,a),/^db\-.*\-read$/.test(a.id)?(con("Readstate update"),sys.get(a.id,function(a,b){a||_cmpreads(b.db,b)})):a.deleted?_uncache(dbid,a.id):ext?ext.load([a.id]):"")}var d=0;a||(d=b.update_seq),con(dbid+": last update sequence is "+d),db.changes({since:d,continuous:!0,onChange:c})}),_setViews(db).then(c).fail(function(a){pi.reject(a,"Connection to DB "+dbid+" failed. "+a)}))}),pi.promise()},$.my.ajax(_ajax),cw.me=function(a){return void 0===a?me.name:null===a?Object.clone(me,!0):"locale"===a?(me.locale||window.navigator.language||"en").split("-")[0]:me[a]},cw.dbs=function(){var a={},b=Object.keys(dbs);return b.forEach(function(b){a[b]=dbs[b].title()}),a},cw.version=function(){return VERSION},cw.version.toString=function(){return VERSION},Object.merge(cw,{CW:CW,locked:_locked,lock:_lock,state:Object.clone(state),db:function(a){return dbs[a]?Object.merge({},dbs[a]):null},con:function(){con.apply(null,arguments)},ram:function(a,b){return ram[a]&&ram[a][b]?ram[a][b]:null},note:_note,read:read,reg:_register,start:_startCloudwall})}(cw);